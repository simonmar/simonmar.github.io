%!PS-Adobe-2.0
%%Creator: dvips(k) 5.86 Copyright 1999 Radical Eye Software
%%Pages: 11
%%PageOrder: Ascend
%%BoundingBox: 0 0 596 842
%%DocumentFonts: Helvetica-Bold Helvetica Times-Bold Times-Roman
%%+ Times-Italic Symbol Courier Courier-Oblique
%%+ ZapfChancery-MediumItalic
%%EndComments
%DVIPSWebPage: (www.radicaleye.com)
%DVIPSCommandLine: dvips -f
%DVIPSParameters: dpi=600, compressed
%DVIPSSource:  TeX output 2004.06.25:0937
%%BeginProcSet: texc.pro
%!
/TeXDict 300 dict def TeXDict begin/N{def}def/B{bind def}N/S{exch}N/X{S
N}B/A{dup}B/TR{translate}N/isls false N/vsize 11 72 mul N/hsize 8.5 72
mul N/landplus90{false}def/@rigin{isls{[0 landplus90{1 -1}{-1 1}ifelse 0
0 0]concat}if 72 Resolution div 72 VResolution div neg scale isls{
landplus90{VResolution 72 div vsize mul 0 exch}{Resolution -72 div hsize
mul 0}ifelse TR}if Resolution VResolution vsize -72 div 1 add mul TR[
matrix currentmatrix{A A round sub abs 0.00001 lt{round}if}forall round
exch round exch]setmatrix}N/@landscape{/isls true N}B/@manualfeed{
statusdict/manualfeed true put}B/@copies{/#copies X}B/FMat[1 0 0 -1 0 0]
N/FBB[0 0 0 0]N/nn 0 N/IEn 0 N/ctr 0 N/df-tail{/nn 8 dict N nn begin
/FontType 3 N/FontMatrix fntrx N/FontBBox FBB N string/base X array
/BitMaps X/BuildChar{CharBuilder}N/Encoding IEn N end A{/foo setfont}2
array copy cvx N load 0 nn put/ctr 0 N[}B/sf 0 N/df{/sf 1 N/fntrx FMat N
df-tail}B/dfs{div/sf X/fntrx[sf 0 0 sf neg 0 0]N df-tail}B/E{pop nn A
definefont setfont}B/Cw{Cd A length 5 sub get}B/Ch{Cd A length 4 sub get
}B/Cx{128 Cd A length 3 sub get sub}B/Cy{Cd A length 2 sub get 127 sub}
B/Cdx{Cd A length 1 sub get}B/Ci{Cd A type/stringtype ne{ctr get/ctr ctr
1 add N}if}B/id 0 N/rw 0 N/rc 0 N/gp 0 N/cp 0 N/G 0 N/CharBuilder{save 3
1 roll S A/base get 2 index get S/BitMaps get S get/Cd X pop/ctr 0 N Cdx
0 Cx Cy Ch sub Cx Cw add Cy setcachedevice Cw Ch true[1 0 0 -1 -.1 Cx
sub Cy .1 sub]/id Ci N/rw Cw 7 add 8 idiv string N/rc 0 N/gp 0 N/cp 0 N{
rc 0 ne{rc 1 sub/rc X rw}{G}ifelse}imagemask restore}B/G{{id gp get/gp
gp 1 add N A 18 mod S 18 idiv pl S get exec}loop}B/adv{cp add/cp X}B
/chg{rw cp id gp 4 index getinterval putinterval A gp add/gp X adv}B/nd{
/cp 0 N rw exit}B/lsh{rw cp 2 copy get A 0 eq{pop 1}{A 255 eq{pop 254}{
A A add 255 and S 1 and or}ifelse}ifelse put 1 adv}B/rsh{rw cp 2 copy
get A 0 eq{pop 128}{A 255 eq{pop 127}{A 2 idiv S 128 and or}ifelse}
ifelse put 1 adv}B/clr{rw cp 2 index string putinterval adv}B/set{rw cp
fillstr 0 4 index getinterval putinterval adv}B/fillstr 18 string 0 1 17
{2 copy 255 put pop}for N/pl[{adv 1 chg}{adv 1 chg nd}{1 add chg}{1 add
chg nd}{adv lsh}{adv lsh nd}{adv rsh}{adv rsh nd}{1 add adv}{/rc X nd}{
1 add set}{1 add clr}{adv 2 chg}{adv 2 chg nd}{pop nd}]A{bind pop}
forall N/D{/cc X A type/stringtype ne{]}if nn/base get cc ctr put nn
/BitMaps get S ctr S sf 1 ne{A A length 1 sub A 2 index S get sf div put
}if put/ctr ctr 1 add N}B/I{cc 1 add D}B/bop{userdict/bop-hook known{
bop-hook}if/SI save N @rigin 0 0 moveto/V matrix currentmatrix A 1 get A
mul exch 0 get A mul add .99 lt{/QV}{/RV}ifelse load def pop pop}N/eop{
SI restore userdict/eop-hook known{eop-hook}if showpage}N/@start{
userdict/start-hook known{start-hook}if pop/VResolution X/Resolution X
1000 div/DVImag X/IEn 256 array N 2 string 0 1 255{IEn S A 360 add 36 4
index cvrs cvn put}for pop 65781.76 div/vsize X 65781.76 div/hsize X}N
/p{show}N/RMat[1 0 0 -1 0 0]N/BDot 260 string N/Rx 0 N/Ry 0 N/V{}B/RV/v{
/Ry X/Rx X V}B statusdict begin/product where{pop false[(Display)(NeXT)
(LaserWriter 16/600)]{A length product length le{A length product exch 0
exch getinterval eq{pop true exit}if}{pop}ifelse}forall}{false}ifelse
end{{gsave TR -.1 .1 TR 1 1 scale Rx Ry false RMat{BDot}imagemask
grestore}}{{gsave TR -.1 .1 TR Rx Ry scale 1 1 false RMat{BDot}
imagemask grestore}}ifelse B/QV{gsave newpath transform round exch round
exch itransform moveto Rx 0 rlineto 0 Ry neg rlineto Rx neg 0 rlineto
fill grestore}B/a{moveto}B/delta 0 N/tail{A/delta X 0 rmoveto}B/M{S p
delta add tail}B/b{S p tail}B/c{-4 M}B/d{-3 M}B/e{-2 M}B/f{-1 M}B/g{0 M}
B/h{1 M}B/i{2 M}B/j{3 M}B/k{4 M}B/w{0 rmoveto}B/l{p -4 w}B/m{p -3 w}B/n{
p -2 w}B/o{p -1 w}B/q{p 1 w}B/r{p 2 w}B/s{p 3 w}B/t{p 4 w}B/x{0 S
rmoveto}B/y{3 2 roll p a}B/bos{/SS save N}B/eos{SS restore}B end

%%EndProcSet
%%BeginProcSet: 8r.enc
% @@psencodingfile@{
%   author = "S. Rahtz, P. MacKay, Alan Jeffrey, B. Horn, K. Berry",
%   version = "0.6",
%   date = "22 June 1996",
%   filename = "8r.enc",
%   email = "kb@@mail.tug.org",
%   address = "135 Center Hill Rd. // Plymouth, MA 02360",
%   codetable = "ISO/ASCII",
%   checksum = "119     662    4424",
%   docstring = "Encoding for TrueType or Type 1 fonts to be used with TeX."
% @}
% 
% Idea is to have all the characters normally included in Type 1 fonts
% available for typesetting. This is effectively the characters in Adobe
% Standard Encoding + ISO Latin 1 + extra characters from Lucida.
% 
% Character code assignments were made as follows:
% 
% (1) the Windows ANSI characters are almost all in their Windows ANSI
% positions, because some Windows users cannot easily reencode the
% fonts, and it makes no difference on other systems. The only Windows
% ANSI characters not available are those that make no sense for
% typesetting -- rubout (127 decimal), nobreakspace (160), softhyphen
% (173). quotesingle and grave are moved just because it's such an
% irritation not having them in TeX positions.
% 
% (2) Remaining characters are assigned arbitrarily to the lower part
% of the range, avoiding 0, 10 and 13 in case we meet dumb software.
% 
% (3) Y&Y Lucida Bright includes some extra text characters; in the
% hopes that other PostScript fonts, perhaps created for public
% consumption, will include them, they are included starting at 0x12.
% 
% (4) Remaining positions left undefined are for use in (hopefully)
% upward-compatible revisions, if someday more characters are generally
% available.
% 
% (5) hyphen appears twice for compatibility with both ASCII and Windows.
% 
/TeXBase1Encoding [
% 0x00 (encoded characters from Adobe Standard not in Windows 3.1)
  /.notdef /dotaccent /fi /fl
  /fraction /hungarumlaut /Lslash /lslash
  /ogonek /ring /.notdef
  /breve /minus /.notdef 
% These are the only two remaining unencoded characters, so may as
% well include them.
  /Zcaron /zcaron 
% 0x10
 /caron /dotlessi 
% (unusual TeX characters available in, e.g., Lucida Bright)
 /dotlessj /ff /ffi /ffl 
 /.notdef /.notdef /.notdef /.notdef
 /.notdef /.notdef /.notdef /.notdef
 % very contentious; it's so painful not having quoteleft and quoteright
 % at 96 and 145 that we move the things normally found there down to here.
 /grave /quotesingle 
% 0x20 (ASCII begins)
 /space /exclam /quotedbl /numbersign
 /dollar /percent /ampersand /quoteright
 /parenleft /parenright /asterisk /plus /comma /hyphen /period /slash
% 0x30
 /zero /one /two /three /four /five /six /seven
 /eight /nine /colon /semicolon /less /equal /greater /question
% 0x40
 /at /A /B /C /D /E /F /G /H /I /J /K /L /M /N /O
% 0x50
 /P /Q /R /S /T /U /V /W
 /X /Y /Z /bracketleft /backslash /bracketright /asciicircum /underscore
% 0x60
 /quoteleft /a /b /c /d /e /f /g /h /i /j /k /l /m /n /o
% 0x70
 /p /q /r /s /t /u /v /w
 /x /y /z /braceleft /bar /braceright /asciitilde
 /.notdef % rubout; ASCII ends
% 0x80
 /.notdef /.notdef /quotesinglbase /florin
 /quotedblbase /ellipsis /dagger /daggerdbl
 /circumflex /perthousand /Scaron /guilsinglleft
 /OE /.notdef /.notdef /.notdef
% 0x90
 /.notdef /.notdef /.notdef /quotedblleft
 /quotedblright /bullet /endash /emdash
 /tilde /trademark /scaron /guilsinglright
 /oe /.notdef /.notdef /Ydieresis
% 0xA0
 /.notdef % nobreakspace
 /exclamdown /cent /sterling
 /currency /yen /brokenbar /section
 /dieresis /copyright /ordfeminine /guillemotleft
 /logicalnot
 /hyphen % Y&Y (also at 45); Windows' softhyphen
 /registered
 /macron
% 0xD0
 /degree /plusminus /twosuperior /threesuperior
 /acute /mu /paragraph /periodcentered
 /cedilla /onesuperior /ordmasculine /guillemotright
 /onequarter /onehalf /threequarters /questiondown
% 0xC0
 /Agrave /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla
 /Egrave /Eacute /Ecircumflex /Edieresis
 /Igrave /Iacute /Icircumflex /Idieresis
% 0xD0
 /Eth /Ntilde /Ograve /Oacute
 /Ocircumflex /Otilde /Odieresis /multiply
 /Oslash /Ugrave /Uacute /Ucircumflex
 /Udieresis /Yacute /Thorn /germandbls
% 0xE0
 /agrave /aacute /acircumflex /atilde
 /adieresis /aring /ae /ccedilla
 /egrave /eacute /ecircumflex /edieresis
 /igrave /iacute /icircumflex /idieresis
% 0xF0
 /eth /ntilde /ograve /oacute
 /ocircumflex /otilde /odieresis /divide
 /oslash /ugrave /uacute /ucircumflex
 /udieresis /yacute /thorn /ydieresis
] def

%%EndProcSet
%%BeginProcSet: texps.pro
%!
TeXDict begin/rf{findfont dup length 1 add dict begin{1 index/FID ne 2
index/UniqueID ne and{def}{pop pop}ifelse}forall[1 index 0 6 -1 roll
exec 0 exch 5 -1 roll VResolution Resolution div mul neg 0 0]/Metrics
exch def dict begin Encoding{exch dup type/integertype ne{pop pop 1 sub
dup 0 le{pop}{[}ifelse}{FontMatrix 0 get div Metrics 0 get div def}
ifelse}forall Metrics/Metrics currentdict end def[2 index currentdict
end definefont 3 -1 roll makefont/setfont cvx]cvx def}def/ObliqueSlant{
dup sin S cos div neg}B/SlantFont{4 index mul add}def/ExtendFont{3 -1
roll mul exch}def/ReEncodeFont{CharStrings rcheck{/Encoding false def
dup[exch{dup CharStrings exch known not{pop/.notdef/Encoding true def}
if}forall Encoding{]exch pop}{cleartomark}ifelse}if/Encoding exch def}
def end

%%EndProcSet
TeXDict begin 39158280 55380996 1000 600 600 () @start
%DVIPSBitmapFont: Fa cmmi10 12 1
/Fa 1 94 df<1407A5120EAF157015F0141F14FF130F137F000FB5FC5AB61280150014E7
140713F01380EAFE0012EE120EB3A9157015F0141F14FF130F137F000FB5FC5AB6128015
0014E7140713F01380EAFE0012EE120EA891C7FCA51C5C7BC627>93
D E
%EndDVIPSBitmapFont
/Fc 201[29 54[{TeXBase1Encoding ReEncodeFont}1 58.1154
/Times-Roman rf
%DVIPSBitmapFont: Fd cmsy10 7 1
/Fd 1 49 df<EA03E013F01207A313E0120FA213C0A3EA1F80A31300A2123EA3123CA212
7C1278A3127012F05AA20C1D7E9F10>48 D E
%EndDVIPSBitmapFont
/Fe 139[16 23 9[16 6[29 19[39 78[{TeXBase1Encoding ReEncodeFont}5
58.1154 /Times-Italic rf /Ff 154[26 101[{}1 58.1154 /Symbol
rf
%DVIPSBitmapFont: Fg cmr10 9 5
/Fg 5 94 df<EB0180EB030013065B5B13385B5BA2485AA2485A120790C7FCA25A120E12
1EA2121C123CA312381278A512F8A25AAD7EA21278A51238123CA3121C121EA2120E120F
7EA27F12036C7EA26C7EA213707F13187F7F7FEB0180114B79B71D>40
D<12C012607E7E7E120E7E6C7EA26C7EA26C7E7F1370A213781338133CA2131C131EA313
0E130FA51480A21307AD130FA21400A5130E131EA3131C133CA2133813781370A213F05B
485AA2485AA248C7FC120E120C5A5A5A5A114B7CB71D>I<B91280A3CCFCADB91280A331
137C9B3A>61 D<EAFFE0A3EAE000B3B3B3AFEAFFE0A30B4B78B715>91
D<EAFFE0A31200B3B3B3AF12FFA30B4B7FB715>93 D E
%EndDVIPSBitmapFont
%DVIPSBitmapFont: Fh cmmi10 9 2
/Fh 2 94 df<123C127EB4FCA21380A2127F123D1201A412031300A25A1206120E120C5A
12385A122009177A8715>59 D<EB0180A41218AC14F01303131F13FF121F5AB512C01480
13F11381EAFC0112F81218B3A214F01303131F13FF121F5AB512C0148013F11381EAFC01
12F81218A790C7FCA414477CB51D>93 D E
%EndDVIPSBitmapFont
/Fi 138[55 2[55 2[55 55 2[55 2[55 1[55 55 55 2[55 12[55
55 3[55 5[55 6[55 66[{TeXBase1Encoding ReEncodeFont}15
91.3242 /Courier-Oblique rf /Fj 134[41 3[46 25 36 36
1[46 46 46 1[25 2[25 46 46 1[41 46 1[46 46 16[56 12[61
12[46 1[46 46 46 46 2[23 46[{TeXBase1Encoding ReEncodeFont}24
91.3242 /Times-Italic rf /Fk 134[37 37 2[42 25 29 33
42 42 37 42 62 21 2[21 42 37 1[33 42 1[42 37 8[54 75
2[50 1[54 2[58 54 71 50 58 1[29 58 1[46 50 54 54 50 54
6[25 5[37 37 37 37 2[19 25 45[{TeXBase1Encoding ReEncodeFont}43
74.7198 /Times-Bold rf /Fl 103[38 29[38 38 38 38 38 38
38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38
38 38 1[38 6[38 1[38 1[38 38 2[38 38 1[38 38 2[38 38
1[38 38 1[38 38 3[38 38 38 1[38 5[38 1[38 38 38 38 38
38 38 2[38 38 3[38 1[38 34[{
.85 ExtendFont TeXBase1Encoding ReEncodeFont}58 74.7198
/Courier rf /Fm 138[33 18 26 22 1[33 33 1[52 18 33 1[18
33 2[29 33 1[33 29 9[63 2[41 37 10[48 19[33 1[33 1[33
3[17 44[{TeXBase1Encoding ReEncodeFont}23 66.4176 /Times-Roman
rf /Fn 177[59 5[57 72[{TeXBase1Encoding ReEncodeFont}2
83.9849 /ZapfChancery-MediumItalic rf /Fo 139[33 14[33
101[{}2 74.7198 /Symbol rf
%DVIPSBitmapFont: Fp cmsy10 9 6
/Fp 6 107 df<EB3FC0EBFFF0000313FC487F487F4814804814C0A24814E0A2B612F0A8
6C14E0A26C14C0A26C14806C14006C5B6C5BC613F0EB3FC01C1C7CA025>15
D<EE01C0A28316008317781738173C8383717E717EB97E8484CB123E84F007C0F003F0F0
00FEF13FC0191FF17E00F001F8F007E0F00F80061EC7FC187CB95A18E060CAEA07804DC8
FCA2171E5F173817785F5F16015FA2422B7CA74B>41 D<0060ED018000E01503B3B06C15
070070160000785D0038150E003C151E6C5D6C5DD807C0495AD803F0EB07E06CB4EB7FC0
6C6CB5C7FC011F13FC010113C029307CAD32>91 D<EC0FC0147F903801FC00EB03F0EB07
C0495AA249C7FCB3A6133E133C137C485AEA03E0EAFF8000FCC8FCB47EEA03E0EA01F8EA
007C133C133E7FB3A66D7EA26D7EEB03F0EB01FC9038007FC0140F1A4B7BB725>102
D<12FCEAFFC0EA0FF0EA01F8EA007C7FA27FB3A66D7EA26D7E6D7EEB00F8EC7FC0140F14
7FECF800EB03E0495A495AA249C7FCB3A6133EA25B485AEA0FF0EAFFC000FCC8FC1A4B7B
B725>I<12E0B3B3B3B3A3034B77B715>106 D E
%EndDVIPSBitmapFont
/Fq 74[37 59[33 33 50 33 37 21 29 29 37 37 37 37 54 21
33 1[21 37 37 21 33 37 33 37 37 8[46 62 2[42 37 46 1[46
54 50 62 42 50 1[25 54 1[46 46 54 50 1[46 13[37 37 1[37
2[25 19 44[{TeXBase1Encoding ReEncodeFont}48 74.7198
/Times-Italic rf /Fr 104[75 37 1[33 33 24[33 37 37 54
37 37 21 29 25 37 37 37 37 58 21 37 21 21 37 37 25 33
37 33 37 33 3[25 1[25 2[54 71 1[54 46 42 50 1[42 54 54
66 46 54 29 25 54 54 42 46 54 50 50 54 1[33 3[21 21 37
37 37 37 37 37 37 37 37 37 21 19 25 19 2[25 25 25 35[42
42 2[{TeXBase1Encoding ReEncodeFont}76 74.7198 /Times-Roman
rf /Fs 134[50 50 72 50 55 33 39 44 1[55 50 55 83 28 55
1[28 55 50 33 44 55 44 55 50 9[100 1[72 66 55 72 2[78
72 94 2[50 39 78 78 61 66 72 72 66 72 7[50 50 50 50 50
50 50 50 50 1[28 25 33 5[33 36[55 2[{TeXBase1Encoding ReEncodeFont}55
99.6264 /Times-Bold rf
%DVIPSBitmapFont: Ft cmsy10 12 2
/Ft 2 104 df<ED0FE015FF913803FC00EC0FE0EC3FC04A5A4AC7FC5C495AA2495AB3AD
495AA2495A131F495A495A01FEC8FCEA07F8EAFFE0A2EA07F8EA00FEEB7F806D7E6D7E13
0F6D7EA26D7EB3AD6D7EA26D7E806E7E6E7EEC0FE0EC03FC913800FFE0150F236479CA32
>102 D<12FEEAFFE0EA07F8EA00FEEB7F806D7E6D7E130F6D7EA26D7EB3AD6D7EA26D7E
806E7E6E7EEC0FE0EC03FC913800FFE0A2913803FC00EC0FE0EC3FC04A5A4AC7FC5C495A
A2495AB3AD495AA2495A131F495A495A01FEC8FCEA07F8EAFFE048C9FC236479CA32>I
E
%EndDVIPSBitmapFont
/Fu 139[21 37 25 2[42 1[62 3[17 42 42 21 42 42 37 42
42 11[54 2[54 4[62 42 50 7[54 20[21 1[21 44[{
TeXBase1Encoding ReEncodeFont}22 74.7193 /Helvetica rf
/Fv 134[45 45 65 2[25 45 30 1[50 50 50 75 20 1[20 20
50 50 25 50 50 45 1[50 9[85 2[55 60 2[60 2[75 2[45 9[91
17[25 1[25 44[{TeXBase1Encoding ReEncodeFont}29 89.6632
/Helvetica rf /Fw 134[75 75 105 1[82 45 75 52 2[82 82
1[37 75 1[37 82 82 45 75 82 75 1[75 23[37 97 1[82 90
1[97 67[{TeXBase1Encoding ReEncodeFont}24 134.495 /Helvetica-Bold
rf end
%%EndProlog
%%BeginSetup
%%Feature: *Resolution 600dpi
TeXDict begin
%%PaperSize: A4

%%EndSetup
%%Page: 1 1
1 0 bop 231 245 a Fw(Extending)38 b(the)f(Haskell)g(Foreign)i(Function)
f(Interface)f(with)1536 395 y(Concurrenc)o(y)208 700
y Fv(Simon)24 b(Mar)q(lo)o(w)g(and)g(Simon)g(P)l(e)n(yton)g(Jones)310
783 y Fu(Microsoft)c(Research)f(Ltd.,)g(Cambr)q(idge)o(,)f(U)m(.K.)264
916 y Ft(f)p Fv(simonmar)l(,simonpj)p Ft(g)p Fv(@microsoft.com)2563
700 y(W)m(olfgang)24 b(Thaller)2382 833 y(w)o(olfgang.thaller@gmx.net)
-150 1353 y Fs(Abstract)-150 1537 y(1)99 b(Intr)n(oduction)-150
1704 y Fr(T)-6 b(w)o(o)29 b(of)h(the)f(most)g(longest-standing)i(and)f
(widely-used)g(e)o(xtensions)h(to)-150 1787 y(Hask)o(ell)f(98)f(are)h
(Concurrent)g(Hask)o(ell)f([10)q(])g(and)h(the)f(Hask)o(ell)h(F)o
(oreign)-150 1870 y(Function)21 b(Interf)o(ace)f([7)q(].)26
b(These)20 b(tw)o(o)h(features)f(were)g(speci\002ed)h(indepen-)-150
1953 y(dently)-5 b(,)31 b(b)o(ut)d(their)g(combination)i(is)e(quite)g
(trick)o(y)-5 b(,)31 b(especially)e(when)g(the)-150 2036
y(FFI)18 b(is)g(used)i(to)f(interact)f(with)h(multi-threaded)h(foreign)
f(programs.)-150 2202 y(The)j(core)h(question)g(is)f(this:)29
b(what)22 b(is)g(the)h(relationship)f(between)h(the)g(na-)-150
2285 y(ti)n(v)o(e)15 b(threads)g(supported)h(by)f(the)g(operating)g
(system)g(\(the)g Fq(OS)g(thr)m(eads)p Fr(\),)h(and)-150
2368 y(the)k(lightweight)g(threads)h(of)n(fered)f(by)h(Concurrent)f
(Hask)o(ell)h(\(the)e Fq(Hask)o(ell)-150 2451 y(thr)m(eads)p
Fr(\)?)44 b(From)25 b(the)g(programmer')l(s)h(point)g(of)f(vie)n(w)-5
b(,)27 b(the)f(simplest)f(so-)-150 2534 y(lution)f(is)f(to)g(require)h
(that)f(the)g(tw)o(o)h(are)f(in)h(one-to-one)g(correspondence.)-150
2617 y(Ho)n(we)n(v)o(er)m(,)19 b(part)g(of)g(the)g(design)g(philosophy)
i(of)e(Concurrent)g(Hask)o(ell)g(is)g(to)-150 2700 y(support)e(e)o
(xtremely)f(numerous,)h(lightweight)f(threads,)h(which)f(\(in)f(today')
l(s)-150 2783 y(technology)22 b(at)e(an)o(y)h(rate\))f(is)g
(incompatible)h(with)f(a)g(one-to-one)h(mapping)-150
2866 y(to)d(OS)g(threads.)23 b(Instead,)c(in)f(the)h(absence)g(of)g
(FFI)e(issues,)h(the)h(natural)f(im-)-150 2949 y(plementation)i(for)g
(Concurrent)g(Hask)o(ell)g(is)f(to)g(multiple)o(x)h(all)f(the)g(Hask)o
(ell)-150 3032 y(threads)g(onto)h(a)f(single)g(OS)f(thread.)-150
3198 y(In)24 b(this)f(paper)i(we)e(sho)n(w)i(ho)n(w)f(to)g(combine)h
(the)f(clean)g(semantics)g(of)g(the)-150 3281 y(one-to-one)c
(programming)g(model)f(with)f(the)h(performance)g(of)g(the)f(multi-)
-150 3364 y(ple)o(x)o(ed)i(implementation.)k(Speci\002cally)18
b(we)h(mak)o(e)h(the)f(follo)n(wing)h(contri-)-150 3447
y(b)o(utions:)-63 3594 y Fp(\017)42 b Fr(First)14 b(we)i(tease)f(out)h
(a)g(number)g(of)g(non-ob)o(vious)i(w)o(ays)e(in)f(which)h(this)16
3677 y(basic)21 b(multiple)o(x)o(ed)f(model)h(con\003icts)f(with)g(the)
g(simple)g(one-to-one)16 3760 y(programming)25 b(model,)g(and)g(sk)o
(etch)f(ho)n(w)g(the)g(multiple)o(x)o(ed)g(model)16 3844
y(can)19 b(be)h(elaborated)g(to)e(cope)i(\(Section)f(3\).)-63
3964 y Fp(\017)42 b Fr(W)-6 b(e)38 b(propose)h(a)f(modest)h(e)o
(xtension)g(to)g(the)f(language,)44 b(namely)16 4047
y Fq(bound)33 b(thr)m(eads)p Fr(.)60 b(The)32 b(k)o(e)o(y)f(idea)h(is)e
(to)h(distinguish)h(the)f(Hask)o(ell)16 4130 y(threads)22
b(which)f(must)g(be)h(in)f(one-to-one)h(correspondence)i(with)c(an)16
4213 y(OS)d(thread)i(for)e(the)h(purpose)i(of)e(making)g(foreign)h
(calls,)e(from)h(those)16 4296 y(that)26 b(don')o(t)f(need)i(to)f(be.)
43 b(This)26 b(gi)n(v)o(es)g(the)f(programmer)i(the)f(bene-)16
4379 y(\002ts)20 b(of)h(one-to-one)h(correspondence)i(when)d(necessary)
-5 b(,)22 b(while)f(still)16 4462 y(allo)n(wing)k(the)g(implementation)
g(to)g(pro)o(vide)g(ef)n(\002cient)g(lightweight)-149
5402 y Fm(Submitted)19 b(to)e(The)g(Hask)o(ell)i(W)-5
b(orkshop,)17 b(2004)2215 1353 y Fr(threads.)2215 1474
y(W)-6 b(e)14 b(e)o(xpress)i(the)f(design)g(as)g(a)g(concrete)h(set)e
(of)h(proposed)i(e)o(xtensions)2215 1557 y(or)f(clari\002cations)f(to)h
(the)g(e)o(xisting)g(designs)h(for)f(the)f(Hask)o(ell)i(FFI)d(and)2215
1640 y(Concurrent)20 b(Hask)o(ell)f(\(Section)g(4\).)2136
1760 y Fp(\017)42 b Fr(W)-6 b(e)17 b(gi)n(v)o(e)i(a)e(precise)i
(speci\002cation)f(of)g(the)f(e)o(xtension)i(in)f(terms)g(of)f(an)2215
1843 y(operational)j(semantics)f(\(Section)g(5\).)2136
1963 y Fp(\017)42 b Fr(W)-6 b(e)23 b(sk)o(etch)h(three)f(possible)h
(implementations,)g(one)g(of)f(which)g(has)2215 2046
y(been)37 b(implemented)f(in)g(a)f(production)j(compiler)m(,)h(the)d
(Glasgo)n(w)2215 2130 y(Hask)o(ell)19 b(Compiler[1)q(])f(\(Section)h
(6\).)2049 2330 y Fs(2)99 b(Backgr)n(ound)2049 2496 y
Fr(Concurrenc)o(y)20 b(and)f(the)g(foreign-function)h(interf)o(ace)f
(are)g(tw)o(o)f(of)h(the)g(most)2049 2579 y(long-standing)30
b(and)f(widely)g(used)g(e)o(xtensions)h(to)e(Hask)o(ell)h(98.)53
b(In)28 b(this)2049 2662 y(section)17 b(we)g(brie\003y)f(introduce)i
(both)g(features,)f(establish)g(our)g(conte)o(xt)g(and)2049
2745 y(terminology)-5 b(.)2049 2945 y Fs(2.1)99 b(The)26
b(F)n(or)n(eign)f(Function)h(Interface)2049 3112 y Fr(The)20
b(F)o(oreign)g(Function)h(Interf)o(ace)f(e)o(xtends)h(Hask)o(ell)g(98)f
(with)g(the)g(ability)2049 3195 y(to)k(call,)h(and)g(be)g(called)g(by)
-5 b(,)26 b(e)o(xternal)e(programs)i(written)d(in)i(some)f(other)2049
3278 y(language)30 b(\(usually)g(C\).)d(A)i Fl(foreign)39
b(import)29 b Fr(declaration)h(declares)f(a)2049 3361
y(foreign)k(function)g(that)e(may)i(be)f(called)h(from)f(Hask)o(ell,)j
(and)e(gi)n(v)o(es)f(its)2049 3444 y(Hask)o(ell)19 b(type.)24
b(F)o(or)18 b(e)o(xample:)2049 3611 y Fl(foreign)39 b(import)g(ccall)f
(safe)h("malloc")2125 3694 y(malloc)g(::)f(CSize)h(->)f(IO)h(\(Ptr)f
(\(\)\))2049 3860 y Fr(declares)29 b(that)g(the)f(e)o(xternal)h
(function)h Fl(malloc)f Fr(may)g(be)g(in)m(v)o(ok)o(ed)h(from)2049
3943 y(Hask)o(ell)21 b(using)g(the)g Fl(ccall)g Fr(calling)g(con)m(v)o
(ention.)30 b(It)20 b(tak)o(es)i(one)f(ar)o(gument)2049
4026 y(of)e(type)h Fl(CSize)f Fr(\(a)g(type)g(which)h(is)f(equi)n(v)n
(alent)h(to)f(C')l(s)f Fl(size_t)i Fr(type\),)f(and)2049
4109 y(returns)24 b(a)f(v)n(alue)h(of)f(type)h Fl(Ptr)38
b(\(\))23 b Fr(\(a)h(pointer)f(type)h(parameterised)g(with)2049
4192 y Fl(\(\))p Fr(,)19 b(which)g(normally)g(indicates)h(a)f(pointer)g
(to)g(an)g(untyped)h(v)n(alue\).)2049 4358 y(Similarly)-5
b(,)39 b(a)c Fl(foreign)k(export)d Fr(declaration)h(identi\002es)e(a)h
(particular)2049 4441 y(Hask)o(ell)26 b(function)g(as)g(e)o
(xternally-callable,)h(and)g(causes)f(the)g(generation)2049
4524 y(of)21 b(some)g(impedance)h(matching)g(code)g(to)e(pro)o(vide)i
(the)f(Hask)o(ell)g(function)2049 4607 y(with)e(the)g(foreign)g
(calling)g(con)m(v)o(ention.)25 b(F)o(or)18 b(e)o(xample:)2049
4755 y Fl(foreign)39 b(export)g(ccall)f("plus")2163 4838
y(addInt)h(::)f(CInt)h(->)f(CInt)h(->)f(CInt)2049 4985
y Fr(declares)21 b(the)f(Hask)o(ell)h(function)g Fl(addInt)f
Fr(\(which)h(should)g(be)g(in)f(scope)h(at)2049 5068
y(this)i(point\))h(as)g(an)g(e)o(xternally-callable)g(function)h
Fl(plus)e Fr(with)h(the)f Fl(ccall)2049 5151 y Fr(calling)c(con)m(v)o
(ention.)2049 5317 y(A)24 b Fl(foreign)38 b(import)25
b Fr(declaration)f(may)h(be)f(annotated)h(with)f(the)f(modi-)2049
5400 y(\002ers)j(\223)p Fl(safe)p Fr(\224)g(or)h(\223)p
Fl(unsafe)p Fr(\224,)h(where)f Fl(safe)f Fr(is)g(the)g(def)o(ault)h
(and)g(may)f(be)1931 5649 y(1)p eop
%%Page: 2 2
2 1 bop -150 83 a Fr(omitted.)22 b(A)17 b(foreign)g(function)h
(declared)f(as)g Fl(safe)g Fr(may)g(indirectly)g(in)m(v)o(ok)o(e)-150
166 y(Hask)o(ell)30 b(functions,)i(whereas)e(an)f Fl(unsafe)h
Fr(one)g(may)g(not)f(\(that)g(is,)i(do-)-150 249 y(ing)19
b(so)g(results)g(in)g(unde\002ned)i(beha)o(viour\).)j(The)19
b(distinction)g(is)g(moti)n(v)n(ated)-150 332 y(purely)g(by)f
(performance)i(considerations:)k(an)19 b(unsafe)f(call)g(is)g(lik)o
(ely)g(to)g(be)-150 415 y(f)o(aster)j(than)h(a)f(safe)h(call,)f
(because)i(it)e(does)h(not)f(need)i(to)e(sa)o(v)o(e)g(the)h(state)f(of)
-150 498 y(the)h(Hask)o(ell)h(system)f(in)g(such)h(a)f(w)o(ay)h(that)f
(re-entry)-5 b(,)23 b(and)g(hence)g(garbage)-150 581
y(collection,)h(can)g(be)g(performed)g(safely\227for)f(e)o(xample,)i
(sa)o(ving)e(all)g(tem-)-150 664 y(porary)g(v)n(alues)g(on)f(the)g
(stack)g(such)h(that)f(the)g(garbage)h(collector)f(can)h(\002nd)-150
747 y(them.)32 b(It)21 b(is)g(intended)i(that,)f(in)g(a)f(compiled)i
(implementation,)g(an)f(unsafe)-150 830 y(foreign)d(call)g(can)g(be)h
(implemented)g(as)e(a)h(simple)g(inline)g(function)h(call.)-150
996 y(W)-6 b(e)22 b(use)h(Hask)o(ell-centric)g(terminology:)31
b(the)22 b(act)g(of)h(a)f(Hask)o(ell)h(program)-150 1079
y(calling)16 b(a)g(foreign)h(function)g(\(via)f Fl(foreign)h(import)p
Fr(\))g(is)e(termed)i(a)f Fq(for)m(eign)-150 1162 y(out-call)i
Fr(or)g(sometimes)g(just)f Fq(for)m(eign)i(call)p Fr(;)f(and)g(the)g
(act)g(of)g(a)f(foreign)i(pro-)-150 1245 y(gram)27 b(calling)f(a)g
(Hask)o(ell)h(function)g(\(via)f Fl(foreign)h(export)p
Fr(\))g(is)f Fq(for)m(eign)-150 1328 y(in-call)p Fr(.)-150
1546 y Fs(2.2)99 b(Concurr)n(ent)27 b(Hask)o(ell)-150
1713 y Fr(Concurrent)34 b(Hask)o(ell)g(is)f(an)h(e)o(xtension)h(to)e
(Hask)o(ell)h(that)f(of)n(fers)h(light-)-150 1796 y(weight)e
(concurrent)h(threads)g(that)e(can)i(perform)f(input/output[10)r(].)61
b(It)-150 1879 y(aims)24 b(to)g(increase)g Fq(e)o(xpr)m(essiveness)p
Fr(,)j(rather)d(than)g Fq(performance)p Fr(;)k(A)c(Con-)-150
1962 y(current)i(Hask)o(ell)g(program)h(is)e(typically)h(e)o(x)o
(ecuted)h(on)f(a)g(uni-processor)m(,)-150 2045 y(and)i(may)g(ha)o(v)o
(e)g(dozens)h(or)f(hundreds)h(of)f(threads,)i(most)e(of)g(which)g(are)
-150 2128 y(block)o(ed.)46 b(Non-determinism)27 b(is)f(part)g(of)g(the)
g(speci\002cation;)j(for)d(e)o(xam-)-150 2211 y(ple,)20
b(tw)o(o)h(threads)g(may)f(dra)o(w)h(to)f(the)g(same)h(windo)n(w)g(and)
g(the)f(results)g(are,)-150 2294 y(by)i(design,)h(dependent)h(on)e(the)
g(order)g(in)f(which)h(the)o(y)g(e)o(x)o(ecute.)33 b(Concur)o(-)-150
2377 y(rent)27 b(Hask)o(ell)g(pro)o(vides)g(a)g(mechanism,)i(called)e
Fl(MVar)p Fr(s,)i(through)e(which)-150 2460 y(threads)18
b(may)g(synchronise)i(and)e(cooperate)h(safely)-5 b(,)18
b(b)o(ut)g(we)f(will)g(not)h(need)-150 2543 y(to)h(discuss)g
Fl(MVar)p Fr(s)h(in)e(this)h(paper)l(.)-150 2709 y(F)o(or)14
b(the)h(purposes)h(of)f(this)f(paper)m(,)i(the)f(only)g(Concurrent)g
(Hask)o(ell)g(f)o(acilities)-150 2792 y(that)k(we)g(need)g(to)g
(consider)h(are)f(the)g(follo)n(wing:)-74 2940 y Fl(data)39
b(ThreadId)g(--)f(abstract,)h(instance)g(of)f(Eq,)h(Ord)-74
3023 y(myThreadId)g(::)g(IO)f(ThreadId)-74 3106 y(forkIO)h(::)f(IO)h
(\(\))f(->)g(IO)h(ThreadId)-150 3253 y Fr(The)15 b(abstract)g(type)g
Fl(ThreadId)g Fr(type)g(represents)h(the)e(identity)h(of)g(a)f(Hask)o
(ell)-150 3336 y(thread.)58 b(The)31 b(function)g Fl(myThreadId)g
Fr(pro)o(vides)h(a)e(w)o(ay)h(to)g(obtain)g(the)-150
3419 y Fl(ThreadId)g Fr(of)g(the)g(current)g(thread.)58
b(Ne)n(w)31 b(threads)g(are)g(created)g(using)-150 3502
y Fl(forkIO)p Fr(,)i(which)g(tak)o(es)h(an)f Fl(IO)g
Fr(computation)h(to)f(perform)h(in)e(the)h(ne)n(w)-150
3585 y(thread,)28 b(and)f(returns)g(the)f Fl(ThreadId)h
Fr(of)f(the)g(ne)n(w)h(thread.)45 b(The)26 b(ne)n(wly-)-150
3668 y(created)e(thread)h(runs)f(concurrently)h(with)f(the)g(other)g
(Hask)o(ell)g(threads)h(in)-150 3751 y(the)19 b(system.)-150
3917 y(Details)41 b(on)i(the)f(rest)f(of)h(the)g(operations)h(pro)o
(vided)g(by)g(Concurrent)-150 4000 y(Hask)o(ell)g(can)f(be)h(found)g
(in)f([10)q(])g(and)h(the)f(documentation)j(for)d(the)-150
4083 y Fl(Control.Concurrent)21 b Fr(library)d(distrib)o(uted)h(with)g
(GHC[1].)-150 4301 y Fs(2.3)99 b(Hask)o(ell)24 b(thr)n(eads)i(and)g(OS)
f(thr)n(eads)-150 4468 y Fr(Ev)o(ery)17 b(operating)g(system)g(nati)n
(v)o(ely)g(supports)h(some)f(notion)h(of)e(\223threads\224,)-150
4551 y(so)35 b(it)g(is)g(natural)g(to)g(ask)h(ho)n(w)f(these)h(threads)
f(map)h(onto)g(Concurrent)-150 4634 y(Hask)o(ell')l(s)24
b(notion)h(of)f(a)g(\223thread\224.)39 b(Furthermore,)25
b(this)f(mapping)h(is)e(inti-)-150 4717 y(mately)17 b(tied)f(up)i(with)
e(the)h(FFI/concurrenc)o(y)g(interaction)g(that)f(we)h(e)o(xplore)-150
4800 y(in)i(this)f(paper)l(.)-150 4966 y(T)-6 b(o)23
b(a)o(v)o(oid)g(confusion)h(in)f(the)g(follo)n(wing)h(discussion,)h(we)
e(de\002ne)g(the)g(fol-)-150 5049 y(lo)n(wing)c(terminology:)-63
5197 y Fp(\017)42 b Fr(A)16 b Fq(Hask)o(ell)h(thr)m(ead)j
Fr(is)c(a)g(thread)h(in)g(a)f(Concurrent)h(Hask)o(ell)g(program.)-63
5317 y Fp(\017)42 b Fr(An)25 b(operating)h(system)f(thread)g(\(or)g
Fq(OS)g(thr)m(ead)r Fr(\))h(is)e(a)h(thread)g(man-)16
5400 y(aged)20 b(by)f(the)g(operating)h(system.)2049
83 y(There)32 b(are)g(three)h(approaches)g(to)g(mapping)g(a)f(system)g
(of)h(lightweight)2049 166 y(threads,)19 b(such)h(as)f(Hask)o(ell)g
(threads,)g(onto)h(the)f(underlying)h(OS)e(threads:)2049
343 y Fk(One-to-one.)41 b Fr(Each)28 b(Hask)o(ell)f(thread)h(is)f(e)o
(x)o(ecuted)i(by)f(a)f(dedicated)i(OS)2215 426 y(thread.)i(This)22
b(system)g(is)f(simple)g(b)o(ut)h(e)o(xpensi)n(v)o(e:)29
b(Hask)o(ell)22 b(threads)2215 509 y(are)17 b(supposed)h(to)f(be)f
(lightweight,)h(with)g(hundreds)h(or)f(thousands)h(of)2215
592 y(threads)h(being)h(entirely)e(reasonable,)i(b)o(ut)e(most)h
(operating)g(systems)2215 675 y(struggle)29 b(to)f(support)i(so)e(man)o
(y)h(OS)f(threads.)52 b(Furthermore,)31 b(an)o(y)2215
758 y(interaction)c(between)g(Hask)o(ell)g(threads)h(\(using)f
Fl(MVar)p Fr(s\))g(must)f(use)2215 841 y(e)o(xpensi)n(v)o(e)20
b(OS-thread)f(f)o(acilities)f(for)h(synchronisation.)2049
962 y Fk(Multiplexed.)39 b Fr(All)22 b(Hask)o(ell)h(threads)g(are)g
(multiple)o(x)o(ed,)h(by)f(the)f(Hask)o(ell)2215 1045
y(runtime)i(system,)i(onto)f(a)f(single)h(OS)e(thread,)j(the)e
Fq(Hask)o(ell)h(e)o(xecu-)2215 1128 y(tion)h(thr)m(ead)p
Fr(.)43 b(Conte)o(xt)26 b(switching)g(between)g(Hask)o(ell)g(threads)g
(oc-)2215 1211 y(curs)17 b(only)h(at)f Fq(yield)g(points)p
Fr(,)h(which)f(the)g(compiler)h(must)f(inject.)22 b(This)2215
1294 y(approach)38 b(allo)n(ws)f(e)o(xtremely)g(lightweight)g(threads)h
(with)e(small)2215 1377 y(stacks.)47 b(Interaction)28
b(between)f(Hask)o(ell)g(threads)h(requires)f(no)h(OS)2215
1460 y(interaction)15 b(because)i(it)d(all)h(tak)o(es)g(place)h(within)
f(a)g(single)g(OS)g(thread.)2049 1580 y Fk(Hybrid.)41
b Fr(Models)30 b(combining)g(the)f(bene\002ts)g(of)g(the)g(pre)n(vious)
h(tw)o(o)f(are)2215 1663 y(possible.)f(F)o(or)20 b(e)o(xample,)i(one)f
(might)f(ha)o(v)o(e)h(a)f(pool)i(of)e(OS)g(\223w)o(ork)o(er)2215
1746 y(threads\224,)29 b(onto)e(which)g(the)g(Hask)o(ell)g(threads)g
(are)g(multiple)o(x)o(ed)g(in)2215 1829 y(some)j(w)o(ay)-5
b(,)32 b(and)d(we)g(will)g(e)o(xplore)g(some)h(such)g(models)g(in)f
(what)2215 1912 y(follo)n(ws.)2049 2089 y(All)17 b(of)g(these)g(are)h
(reasonable)g(implementations)g(of)g(Concurrent)g(Hask)o(ell,)2049
2172 y(each)23 b(with)f(dif)n(ferent)g(tradeof)n(fs)h(between)g
(performance)g(and)g(implemen-)2049 2255 y(tation)16
b(comple)o(xity)-5 b(.)23 b(W)-6 b(e)15 b(do)i(not)f(w)o(ant)g(to)g
(inadv)o(ertently)h(rule)f(an)o(y)g(of)g(these)2049 2338
y(out)j(by)h(o)o(v)o(erspecifying)g(the)f(FFI)f(e)o(xtensions)i(for)f
(concurrenc)o(y)-5 b(.)2049 2504 y(Note)17 b(that)h(our)g(focus)g(is)f
(on)h Fq(e)o(xpr)m(essiveness)p Fr(,)g(and)g(not)g(on)g
Fq(incr)m(easing)h(per)o(-)2049 2587 y(formance)g(thr)m(ough)f(par)o
(allelism)p Fr(.)23 b(In)17 b(f)o(act,)h(all)f(e)o(xisting)h
(implementations)2049 2670 y(of)h(Concurrent)h(Hask)o(ell)g(serialise)f
(the)g(Hask)o(ell)g(threads,)h(e)n(v)o(en)g(on)g(a)f(mul-)2049
2753 y(tiprocessor)l(.)26 b(Whether)20 b(a)g(Hask)o(ell)g
(implementation)g(can)h(ef)n(\002ciently)e(tak)o(e)2049
2836 y(adv)n(antage)k(of)f(a)f(multiprocessor)h(is)f(an)h(open)h
(research)f(question,)g(which)2049 2919 y(we)d(discuss)g(further)g(in)g
(Section)g(7.)2049 3163 y Fs(3)99 b(The)26 b(pr)n(oblem)g(we)f(ar)n(e)h
(trying)f(to)g(solv)o(e)2049 3329 y Fr(Concurrent)g(Hask)o(ell)g(and)g
(the)f(Hask)o(ell)g(FFI)f(were)h(de)n(v)o(eloped)j(indepen-)2049
3413 y(dently)-5 b(,)21 b(b)o(ut)f(the)o(y)g(interact)g(in)g(subtle)h
(and)g(sometimes)f(une)o(xpected)j(w)o(ays.)2049 3496
y(That)c(interaction)g(is)f(the)h(problem)h(we)f(are)g(trying)g(to)g
(solv)o(e.)2049 3662 y(Our)k(design)g(principle)g(is)g(this:)30
b Fq(the)23 b(system)g(should)h(behave)g(as)f(if)f(it)g(was)2049
3745 y(implemented)15 b(with)f(one)h(OS)g(thr)m(ead)g(implementing)g
(eac)o(h)g(Hask)o(ell)g(thr)m(ead)p Fr(.)2049 3828 y(This)26
b(beha)o(viour)h(is)e(simple)h(to)g(e)o(xplain,)i(and)f(a)o(v)o(oids)f
(ha)o(ving)h(to)f(e)o(xpose)2049 3911 y(tw)o(o)19 b(\223layers\224)g
(of)g(threads)h(to)f(the)g(programmer)l(.)2049 4077 y(Ho)n(we)n(v)o(er)
m(,)26 b(if)e(implemented)h(nai)n(v)o(ely)-5 b(,)27 b(the)d(one-to-one)
i(model)f(is)f(e)o(xpen-)2049 4160 y(si)n(v)o(e)j(to)f(implement.)46
b(The)26 b(multiple)o(x)o(ed)h(model)g(is)f(much)h(cheaper)g(and,)2049
4243 y(where)15 b(no)g(foreign)g(calls)f(\(out)h(or)f(in\))g(are)h(in)m
(v)o(olv)o(ed,)h(the)e(one-to-one)i(model)2049 4326 y(and)23
b(the)f(multiple)o(x)o(ed)h(model)g(cannot)g(be)g(distinguished)g(by)g
(the)f(Hask)o(ell)2049 4409 y(program.)39 b(When)24 b(foreign)g
(interaction)g(enters)g(the)g(picture,)h(matters)f(be-)2049
4492 y(come)c(more)g(complicated.)25 b(In)20 b(the)f(rest)g(of)h(this)f
(section)g(we)h(identify)f(se)n(v-)2049 4575 y(eral)e(implicit)g
(consequences)j(of)d(our)g(design)i(principle,)e(and)h(discuss)g(ho)n
(w)2049 4658 y(the)g(multiple)o(x)o(ed)h(implementation)g(technique)h
(can)f(accommodate)h(them.)2049 4901 y Fs(3.1)99 b(F)n(or)n(eign)25
b(calls)f(that)h(block)2049 5068 y Fr(Some)33 b(foreign)g(calls,)j
(such)e(as)f(the)g(C)f(function)i Fl(read\(\))p Fr(,)i(may)e
Fq(bloc)o(k)2049 5151 y Fr(a)o(w)o(aiting)22 b(some)h(e)n(v)o(ent,)g
(or)g(may)f(simply)h(tak)o(e)f(a)h(long)f(time)g(to)g(complete.)2049
5234 y(In)31 b(the)g(absence)h(of)f(concurrenc)o(y)-5
b(,)36 b(the)31 b(Hask)o(ell)g(program)h(making)g(the)2049
5317 y(call)21 b(must)h(also)g(block)g(or)g(tak)o(e)g(a)f(long)i(time,)
e(b)o(ut)h(not)g(so)f(for)h(Concurrent)2049 5400 y(Hask)o(ell.)h
(Indeed,)d(our)f(design)h(principle)f(requires)h(the)f(opposite:)1931
5649 y(2)p eop
%%Page: 3 3
3 2 bop -150 83 a Fk(Requir)o(ement)18 b(1:)41 b Fr(a)19
b Fl(safe)f Fr(foreign)h(call)g(that)f(blocks)h(should)h(block)f(only)
16 166 y(the)31 b(Hask)o(ell)g(thread)h(making)f(the)g(call.)59
b(Other)31 b(Hask)o(ell)g(threads)16 249 y(should)20
b(proceed)g(unimpeded.)-150 396 y(Notice)15 b(that)h(we)f(only)h
(require)g(that)f(a)h Fl(safe)g Fr(foreign)g(call)f(be)h(non-blocking)
-150 479 y(to)23 b(the)g(other)h(Hask)o(ell)f(threads.)37
b(It)23 b(w)o(ould)h(be)f(dif)n(\002cult)g(to)g(mak)o(e)h(a)f(high-)
-150 562 y(performance)c Fl(unsafe)e Fr(foreign)h(call)f(non-blocking,)
i(because)g(that)e(w)o(ould)-150 645 y(force)k(the)g(implementation)h
(to)e(perform)h(the)g(same)g(state-sa)o(ving)g(as)g(for)g(a)-150
729 y Fl(safe)j Fr(call,)g(since)g(the)g(Hask)o(ell)g(system)g(must)f
(continue)i(running)g(during)-150 812 y(the)19 b(call.)-150
978 y(Requirement)i(1)f(seems)h(ob)o(vious)g(enough,)h(b)o(ut)e(the)h
(Hask)o(ell)f(FFI)f(speci\002-)-150 1061 y(cation)g(is)f(silent)g(on)h
(this)f(point,)g(and)i(indeed)f(until)f(recently)h(GHC)f(did)h(not)-150
1144 y(satisfy)e(the)g(requirement.)23 b(This)17 b(caused)h(confusion)h
(to)e(Hask)o(ell)g(program-)-150 1227 y(mers,)24 b(who)f(were)g
(surprised)g(when)h(a)f(foreign)g(call)g(block)o(ed)h(their)f(entire)
-150 1310 y(Concurrent)d(Hask)o(ell)f(program.)-150 1476
y(Requirement)k(1)g(might)g(seem)g(to)g(completely)g(rule)g(out)g(the)f
(multiple)o(x)o(ed)-150 1559 y(implementation,)35 b(because)e(if)f(the)
f(Hask)o(ell)h(e)o(x)o(ecution)h(thread)f(blocks,)-150
1642 y(then)23 b(e)o(x)o(ecution)g(of)f(Hask)o(ell)h(threads)g(will)e
(halt.)34 b(Ho)n(we)n(v)o(er)23 b(a)f(v)n(ariants)h(of)-150
1725 y(the)c(multiple)o(x)o(ed)g(model)h(solv)o(es)f(the)g(problem:)-63
1872 y Fp(\017)42 b Fr(At)18 b(a)g(foreign)g(call,)g(arrange)h(that)f
(the)g(foreign)h(function)g(is)f(e)o(x)o(ecuted)16 1955
y(by)24 b(some)f(other)g(OS)g(thread)g(\(freshly)g(spa)o(wned,)i(or)e
(dra)o(wn)h(from)f(a)16 2038 y(pool\),)k(while)e(e)o(x)o(ecution)h(of)f
(other)h(Hask)o(ell)f(threads)h(is)e(continued)16 2121
y(by)j(the)f(single)g(Hask)o(ell)g(e)o(x)o(ecution)i(thread.)45
b(This)25 b(approach)j(pays)16 2204 y(the)19 b(cost)g(of)g(a)g(OS)f
(thread)h(switch)g(at)g(e)n(v)o(ery)g(\(safe\))g(foreign)h(call.)-150
2352 y(A)f(hybrid)g(model)h(can)f(also)g(be)g(designed)h(to)f(satisfy)g
(this)g(requirement:)-63 2530 y Fp(\017)42 b Fr(Ha)o(v)o(e)25
b(a)f(pool)i(of)e(OS)h(threads,)h(each)f(of)g(which)g
Fq(can)h Fr(play)f(the)g(role)16 2613 y(of)e(the)g(Hask)o(ell)g(e)o(x)o
(ecution)h(thread,)g(b)o(ut)f(only)g(one)h(at)e(a)h(time)f
Fq(does)p Fr(.)16 2696 y(At)d(a)h(safe)g(foreign)g(call,)f(the)h(Hask)o
(ell)g(e)o(x)o(ecution)h(thread)f(lea)o(v)o(es)g(the)16
2779 y(Hask)o(ell)k(w)o(orld)h(to)f(e)o(x)o(ecute)h(the)f(foreign)g
(call,)h(allo)n(wing)f(one)h(\(and)16 2862 y(only)20
b(one\))g(member)g(of)g(the)f(pool)h(to)g(become)g(the)g(ne)n(w)g(Hask)
o(ell)g(e)o(x-)16 2945 y(ecution)g(thread.)k(No)c(OS)e(thread)i(switch)
f(is)g(required)h(on)f(a)g(call,)g(b)o(ut)16 3028 y(on)c(the)g(return)g
(some)g(inter)o(-OS-thread)f(communication)j(is)d(required)16
3111 y(to)22 b(obtain)h(permission)h(to)e(become)i(the)e(Hask)o(ell)h
(e)o(x)o(ecution)g(thread)16 3194 y(again.)-150 3444
y Fs(3.2)99 b(Fixing)24 b(the)i(OS)f(thr)n(ead)h(f)n(or)f(a)g(f)n(or)n
(eign)g(call)-150 3611 y Fr(Some)c(C)g(libraries)g(that)g(one)h(might)g
(wish)f(to)g(call)g(from)g(Hask)o(ell)h(ha)o(v)o(e)f(an)-150
3694 y(a)o(wkw)o(ard)26 b(property:)36 b Fq(it)24 b(matter)o(s)h(whic)o
(h)g(calls)g(to)g(the)g(libr)o(ary)g(ar)m(e)g(made)-150
3777 y(fr)m(om)18 b(whic)o(h)g(OS)h(thr)m(ead)p Fr(.)k(F)o(or)18
b(e)o(xample,)h(man)o(y)g(OpenGL)f(functions)i(ha)o(v)o(e)-150
3860 y(an)h(implicit)f(\223rendering)i(conte)o(xt\224)g(parameter)m(,)f
(which)g(the)g(library)g(stores)-150 3943 y(in)31 b(OS-thread-local)f
(state.)59 b(The)31 b(\(perfectly)g(reasonable\))h(idea)f(is)f(that)
-150 4026 y(OpenGL)22 b(can)f(be)h(used)g(from)f(multiple)g(threads,)i
(for)e(e)o(xample)h(to)f(render)-150 4109 y(into)e(independent)i(windo)
n(ws)e(simultaneously)-5 b(.)-150 4275 y(This)18 b(in)g(turn)g(means)g
(that)g(to)g(use)h(the)f(OpenGL)g(library)g(from)g(Concurrent)-150
4358 y(Hask)o(ell,)h(the)g(FFI)f(must)h(satisfy:)-150
4505 y Fk(Requir)o(ement)f(2:)41 b Fr(it)24 b(must)h(be)g(possible)g
(for)f(a)h(programmer)h(to)e(specify)16 4588 y(that)d(a)g(related)g
(group)h(of)f(foreign)h(calls)f(are)g(all)f(made)i(by)f(the)g(same)16
4671 y(OS)d(thread.)-150 4819 y(Notice)i(that)g(there)h(is)e(no)i
(constraint)g(on)f(which)h(OS)f(thread)g(e)o(x)o(ecutes)h(an)o(y)-150
4902 y(particular)i(Hask)o(ell)g(thread)g(\226)g(we)g(need)g(only)h
(control)f(which)g(OS)f(thread)-150 4985 y(e)o(x)o(ecutes)e(the)f
(foreign)g(calls.)-150 5151 y(Requirement)25 b(2)f(is)f(automatically)i
(satis\002ed)e(by)i(the)f(one-to-one)h(e)o(x)o(ecu-)-150
5234 y(tion)f(model,)g(pro)o(vided)h(we)f(are)f(willing)g(to)g(say)h
(that)g(the)f(\223related\224)h(calls)-150 5317 y(are)31
b(all)g(carried)h(out)g(by)g(a)f(single)h(Hask)o(ell)g(thread.)61
b(The)31 b(multiple)o(x)o(ed)-150 5400 y(model)c(\(basic)g(v)o
(ersion\))h(also)f(automatically)g(satis\002es)f(Requirement)i(2,)2049
83 y(because)h(all)e(foreign)h(calls)f(are)g(e)o(x)o(ecuted)i(by)f(a)f
(single)h(OS)e(thread,)k(b)o(ut)2049 166 y(only)d(at)e(the)h(cost)h(of)
f(violating)g(Requirement)h(1.)45 b(Alas,)27 b(satisfying)f(Re-)2049
249 y(quirement)20 b(1)f(using)h(the)g(v)n(ariant)g(described)g(in)f
(Section)g(3.1,)h(seems)f(to)g(be)2049 332 y(incompatible)h(with)f
(Requirement)h(2,)f(because)i(this)e(v)n(ariant)g(deliberately)2049
415 y(use)e(a)g(pool)g(of)g(interchangeable)h(OS)e(threads.)23
b(The)17 b(hybrid)g(model)h(suf)n(fers)2049 498 y(from)h(the)g(same)g
(problem.)2049 664 y(W)-6 b(e)14 b(are)h(forced,)g(therefore,)h(to)e
(propose)i(a)f(small)f(e)o(xtension)h(to)g(Concurrent)2049
747 y(Hask)o(ell,)k(in)g(which)g(we)g(di)n(vide)g(the)g(Hask)o(ell)h
(threads)f(into)g(tw)o(o)g(groups:)2136 895 y Fp(\017)42
b Fr(A)22 b Fq(bound)h(thr)m(ead)j Fr(has)c(a)g(\002x)o(ed)g
(associated)h(OS)e(thread)i(for)f(making)2215 978 y(FFI)c(calls.)2136
1098 y Fp(\017)42 b Fr(An)28 b Fq(unbound)h(thr)m(ead)i
Fr(has)d(no)g(associated)g(OS)f(thread:)41 b(FFI)26 b(calls)2215
1181 y(from)19 b(this)g(thread)g(may)g(be)h(made)f(in)g(an)o(y)g(OS)g
(thread.)2049 1328 y(The)i(idea)h(is)f(that)h(each)g(bound)h(Hask)o
(ell)f(thread)g(has)f(a)h(dedicated)h(associ-)2049 1411
y(ated)18 b(OS)f(thread.)23 b(It)17 b(is)g(guaranteed)j(that)d(an)o(y)h
(FFI)f(calls)g(made)h(by)h(a)e(bound)2049 1494 y(Hask)o(ell)g(thread)f
(are)h(made)g(by)f(its)g(associated)h(OS)f(thread,)h(although)g(pure-)
2049 1577 y(Hask)o(ell)k(e)o(x)o(ecution)i(can,)e(of)h(course,)g(be)f
(carried)h(out)f(by)h(an)o(y)f(OS)g(thread.)2049 1660
y(A)k(group)h(of)f(foreign)h(calls)f(can)h(thus)f(be)h(guaranteed)h(to)
e(be)g(carried)h(out)2049 1743 y(by)d(the)g(same)g(OS)f(thread)h(if)f
(the)o(y)h(are)g(all)f(performed)i(in)f(a)f(single)h(bound)2049
1826 y(Hask)o(ell)c(thread.)2049 1993 y(W)-6 b(e)16 b(do)i(not)f
(specify)g(that)g(all)g(Hask)o(ell)g(threads)g(are)g(bound,)i(because)f
(doing)2049 2076 y(so)g(w)o(ould)h(specify)f(that)g(Hask)o(ell)g
(threads)g(and)g(OS)f(threads)i(are)f(in)f(one-to-)2049
2159 y(one)26 b(correspondence,)k(which)c(lea)o(v)o(es)g(the)g
(one-to-one)h(implementation)2049 2242 y(model)19 b(as)g(the)g(only)h
(contender)l(.)2049 2408 y(Can)h(se)n(v)o(eral)h(Hask)o(ell)g(threads)g
(be)f(bound)i(to)e(the)h(same)f(OS)g(thread?)31 b(No:)2049
2491 y(this)18 b(w)o(ould)g(pre)n(v)o(ent)h(the)f(one-to-one)h
(implementation)g(model)g(and)f(cause)2049 2574 y(dif)n(\002culties)26
b(for)g(the)g(others.)45 b(F)o(or)26 b(each)g(OS)g(thread,)i(there)e
(is)g(at)g(most)g(a)2049 2657 y(single)19 b(bound)i(Hask)o(ell)e
(thread.)2049 3066 y Fs(3.3)99 b(Multi-thr)n(eaded)27
b(clients)2049 3233 y Fr(Suppose)f(a)g(C)f(program)h(w)o(ants)g(is)f
(using)i(a)e(library)g(written)g(in)h(Hask)o(ell,)2049
3316 y(and)34 b(it)e(in)m(v)o(ok)o(es)i(a)f(Hask)o(ell)g(function)g
(\(via)g Fl(foreign)h(export)p Fr(\).)65 b(This)2049
3399 y(Hask)o(ell)31 b(function)h(forks)g(a)f(Hask)o(ell)g(thread,)j
(and)e(then)f(returns)h(to)f(the)2049 3482 y(C)26 b(program.)46
b(Should)27 b(the)f(spa)o(wned)h(Hask)o(ell)g(thread)g(continue)g(to)f
(run?)2049 3565 y(According)j(to)e(our)h(design)g(principle,)i(it)d
(certainly)h(should)g(\226)g(as)f(f)o(ar)h(as)2049 3648
y(the)17 b(programmer)i(is)e(concerned,)i(there)e(is)g(not)h(much)g
(dif)n(ference)g(between)2049 3731 y(forking)i(a)f(Hask)o(ell)g(thread)
g(and)h(forking)f(an)h(OS)e(thread.)2049 3879 y Fk(Requir)o(ement)g
(3a:)42 b Fr(Hask)o(ell)28 b(threads)h(spa)o(wned)g(by)g(an)f(foreign)h
(in-call)2215 3962 y(continue)20 b(to)f(run)g(after)g(the)g(in-call)f
(returns.)2049 4109 y(A)26 b(closely)h(related)f(issue)g(is)g(this.)45
b(Suppose)27 b(the)g(C)f(program)h(using)g(the)2049 4192
y(Hask)o(ell)c(library)g(itself)g(mak)o(es)g(use)h(of)f(multiple)g(OS)f
(threads.)36 b(Then)23 b(our)2049 4275 y(design)28 b(principle)g
(implies)g(that)f(if)g(one)i(in)m(v)o(ocation)f(runs)g(Hask)o(ell)g
(code)2049 4358 y(that)20 b(blocks)g(\(on)g(an)g Fl(MVar)p
Fr(,)g(say)-5 b(,)20 b(or)g(in)g(another)g(foreign)h(call\))e(that)h
(should)2049 4441 y(not)f(impede)h(the)f(progress)h(of)f(the)g(other)g
(call:)2049 4588 y Fk(Requir)o(ement)f(3b:)41 b Fr(multiple)31
b(OS)f(threads)i(may)f(concurrently)i(in)m(v)o(ok)o(e)2215
4671 y(multiple)23 b(Hask)o(ell)h(functions)g(\(via)g
Fl(foreign)g(export)p Fr(\),)g(and)g(these)2215 4755
y(in)m(v)o(ocations)c(should)g(run)f(concurrently)-5
b(.)2049 4902 y(T)f(o)21 b(support)g(this)g(beha)o(viour)g(in)g(the)g
(multiple)o(x)o(ed)g(model)g(is)g(not)g(dif)n(\002cult,)2049
4985 y(b)o(ut)k(requires)h(some)g(speci\002c)g(mechanism.)44
b(In)25 b(both)i(cases,)g(the)e(current)2049 5068 y(Hask)o(ell)h(e)o(x)
o(ecution)g(OS)f(thread)h(must)g(pay)g(attention)g(to)f(the)h
(possibility)2049 5151 y(of)18 b(another)h(OS)f(thread)h(w)o(anting)g
(to)f(mak)o(e)h(an)g(in-call,)e(lest)h(the)h(latter)e(w)o(ait)2049
5234 y(inde\002nitely)e(while)g(the)f(former)h(chunters)h(a)o(w)o(ay)-5
b(.)22 b(In)15 b(f)o(act,)g(the)g(same)g(mech-)2049 5317
y(anism)20 b(is)g(necessary)h(to)f(respond)h(to)f(an)g(OS)g(thread)g
(returning)h(to)e(Hask)o(ell)2049 5400 y(from)g(a)g(safe)g(foreign)g
(out-call.)1931 5649 y(3)p eop
%%Page: 4 4
4 3 bop -150 83 a Fs(3.4)99 b(Callbacks)-150 250 y Fr(A)27
b(common)h(idiom)g(in)f(GUI)f(libraries)h(is)g(for)g(the)g(application)
h(to)f(mak)o(e)-150 333 y(a)h(call)g(to)h(the)f(e)n(v)o(ent)h(loop)g
(in)f(the)h(library)-5 b(,)30 b(which)f(in)f(turn)h(mak)o(es)g(calls)
-150 416 y(back)e(into)g(the)f(application)h(in)f(the)h(form)f(of)h
(callbacks.)46 b(Callbacks)27 b(are)-150 499 y(re)o(gistered)19
b(prior)g(to)g(in)m(v)o(oking)h(the)f(e)n(v)o(ent)g(loop.)-150
665 y(Consider)h(ho)n(w)f(this)g(w)o(orks)h(for)f(a)g(Hask)o(ell)h
(application)g(calling)f(an)g(e)o(xter)o(-)-150 748 y(nal)c(GUI)g
(library)-5 b(.)22 b(The)15 b(callbacks)h(will)e(be)i
Fl(foreign-export)p Fr(-ed)g(Hask)o(ell)-150 831 y(functions,)g(so)g
(the)f(e)n(v)o(ent)g(loop)h(\(in)f(C\))f(will)g(call)h(the)g(callback)h
(\(in)f(Hask)o(ell\),)-150 914 y(which)30 b(may)h(in)f(turn)g(mak)o(e)h
(a)f(foreign)g(call)g(to)g(a)g(GUI)g(function)g(\(in)g(C)-150
997 y(again\).)22 b(It)16 b(is)g(essential)g(that)g(this)g(latter)g
(call)g(is)g(made)g(using)h(the)g(OS)e(thread)-150 1080
y(as)g(runs)g(the)h(e)n(v)o(ent)f(loop,)h(since)g(the)f(tw)o(o)g(share)
g(thread-local)h(state.)21 b(Hence:)-150 1227 y Fk(Requir)o(ement)d(4:)
41 b Fr(it)25 b(must)g(be)g(possible)h(to)f(ensure)h(that)f(a)g
(foreign)h(out-)16 1311 y(call)e(from)h(Hask)o(ell)g(is)f(made)h(by)g
(the)f(same)h(OS)f(thread)h(that)f(made)16 1394 y(the)19
b(foreign)g(in-call.)-150 1541 y(W)m(ith)c(the)g(notion)h(of)f(bound)i
(threads)f(in)g(hand,)g(this)f(is)g(not)h(hard)g(to)f(achie)n(v)o(e.)
-150 1624 y(W)-6 b(e)19 b(simply)h(specify)g(that)f(a)h(foreign)g
(in-call)f(creates)h(a)f(bound)i(thread,)f(as-)-150 1707
y(sociated)f(with)e(the)h(OS)f(thread)i(that)f(performed)h(the)f
(in-call.)k(An)o(y)c(foreign)-150 1790 y(out-calls)i(made)g(by)g(that)f
(\(bound\))i(Hask)o(ell)f(thread)g(will)f(therefore)h(be)g(e)o(x-)-150
1873 y(ecuted)g(by)f(the)g(in)m(v)o(oking)h(OS)e(thread.)-150
2039 y(Indeed,)26 b(this)e(is)g(the)h Fq(only)g Fr(primiti)n(v)o(e)f
(mechanism)h(for)f(creating)h(a)f(bound)-150 2122 y(thread:)-63
2269 y Fp(\017)42 b Fr(An)i(unbound)i(Hask)o(ell)e(thread)g(is)f
(created)h(using)h(Concurrent)16 2352 y(Hask)o(ell')l(s)19
b(e)o(xisting)g Fl(forkIO)h Fr(combinator)l(.)-63 2473
y Fp(\017)42 b Fr(A)19 b(bound)h(thread)g(is)e(created)h(by)h(a)f
(foreign)g(in)m(v)o(ocation.)-150 2620 y(W)-6 b(e)26
b(pro)o(vide)h(a)f Fl(forkOS)g Fr(combinator)m(,)j(which)e(allo)n(ws)f
(a)g(Hask)o(ell)g(thread)-150 2703 y(\(rather)19 b(than)h(a)f(foreign)h
(in)m(v)o(ocation\))g(to)f(create)h(a)f(ne)n(w)h(bound)g(thread,)g(b)o
(ut)-150 2786 y(it)e(w)o(orks)i(by)g(making)g(a)f(foreign)h(call)e
(with)h(in)m(v)o(ok)o(es)h(a)f(callback)h(\(see)f(Sec-)-150
2869 y(tion)g(4.2.1\).)-150 3104 y Fs(3.5)99 b(Summary)-150
3271 y Fr(This)20 b(concludes)j(our)e(description)h(of)e(the)h
(problems)h(we)f(address,)g(and)h(of)-150 3354 y(the)17
b(core)h(of)f(our)h(design.)23 b(There)17 b(is)g(no)h(ne)n(w)f(syntax,)
h(and)g(only)g(an)f(implicit)-150 3437 y(distinction)i(between)g(tw)o
(o)g(types)g(of)g(Hask)o(ell)g(threads,)g(depending)i(on)e(the)-150
3520 y(w)o(ay)e(in)f(which)h(the)f(thread)h(w)o(as)g(created.)23
b(The)16 b(ne)o(xt)h(section)g(describes)g(the)-150 3603
y(language)j(e)o(xtension)g(in)e(detail,)g(including)i(the)f(small)f
(number)i(of)e(combi-)-150 3686 y(nators)g(that)f(we)h(pro)o(vide)g(as)
g(library)g(functions)g(to)g(allo)n(w)f(programmers)i(to)-150
3769 y(w)o(ork)g(with)g(bound)h(threads.)-150 4003 y
Fs(4)99 b(The)41 b(Concurr)n(ent)h(Hask)o(ell)d(F)n(or)n(eign)h
(Function)-1 4103 y(Interface)-150 4270 y Fr(Thus)27
b(moti)n(v)n(ated,)h(we)e(no)n(w)h(summarise)g(our)g(proposed)h
(changes)f(to)g(the)-150 4353 y(e)o(xisting)21 b(Concurrent)h(Hask)o
(ell)g(design,)g(and)f(the)h(Hask)o(ell)f(FFI)f(speci\002ca-)-150
4436 y(tion.)-150 4671 y Fs(4.1)99 b(Speci\002c)27 b(extensions)-150
4838 y Fr(W)-6 b(e)18 b(propose)j(the)e(follo)n(wing)g(speci\002c)g
(additions:)-150 4985 y Fk(Bound)f(thr)o(eads.)40 b Fr(There)15
b(are)f(tw)o(o)h(types)g(of)f(Hask)o(ell)h(threads,)h
Fq(bound)i Fr(and)16 5068 y Fq(unbound)p Fr(.)48 b(A)27
b(bound)h(thread)f(is)f(permanently)i(associated)g(with)e(a)16
5151 y(particular)16 b(OS)g(thread,)h(and)g(it)e(is)h(guaranteed)i
(that)e(all)g(foreign)g(func-)16 5234 y(tions)h(in)m(v)o(ok)o(ed)h
(from)e(that)h(bound)h(thread)f(will)f(be)g(run)h(in)g(the)g(associ-)16
5317 y(ated)g(OS)g(thread.)23 b(In)17 b(all)g(other)g(w)o(ays,)h(bound)
h(and)f(unbound)h(threads)16 5400 y(beha)o(v)o(e)h(identically)-5
b(.)2215 83 y(An)32 b(OS)e(thread)i(can)g(be)g(associated)g(with)g(at)f
(most)g(one)h(Hask)o(ell)2215 166 y(thread.)2215 286
y(The)18 b(ne)n(w)g(function)h Fl(isCurrentTheadBound)g
Fr(pro)o(vides)g(a)f(w)o(ay)g(for)2215 369 y(the)f(Hask)o(ell)f
(programmer)i(to)e(\002nd)h(out)g(whether)g(the)f(current)h(thread)2215
452 y(is)i(bound)h(or)f(not:)2215 554 y Fl(isCurrentThreadBound)40
b(::)f(IO)f(Bool)2215 656 y Fr(W)-6 b(e)33 b(de\002ne)g
Fl(isCurrentThreadBound)i Fr(to)e(al)o(w)o(ays)h(return)g
Fl(True)2215 739 y Fr(when)17 b(the)g(current)g(Hask)o(ell)g(thread)g
(is)f(a)h(bound)h(thread.)23 b(It)16 b(may)h(also)2215
822 y(return)k Fl(True)g Fr(when)g(the)g(current)g(Hask)o(ell)g(thread)
h(is)e(indistinguish-)2215 905 y(able)26 b(from)h(a)f(bound)h(thread)g
(by)f(both)h(Hask)o(ell)g(code)f(and)h(foreign)2215 988
y(code)20 b(called)f(by)g(it.)2215 1108 y(Therefore,)35
b(an)e(implementation)f(using)h(the)f(one-to-one)h(thread-)2215
1191 y(ing)24 b(model)g(\(see)g(Section)f(6.1\))h(may)g(return)g
Fl(True)g Fr(for)f(all)h(threads,)2215 1274 y(e)n(v)o(en)k(for)e(Hask)o
(ell)h(threads)g(created)g(using)h Fl(forkIO)p Fr(,)f(because)g(e)n(v-)
2215 1357 y(ery)18 b(Hask)o(ell)g(thread)g(has)h(its)e(associated)h(OS)
g(thread)g(and)g(can)h(safely)2215 1440 y(access)h(thread-local)f
(state.)2049 1561 y Fk(F)n(or)o(eign)g(import.)41 b Fr(When)51
b(a)f(Hask)o(ell)h(thread)h(in)m(v)o(ok)o(es)g(a)e Fl(foreign)2215
1644 y(import)16 b Fr(annotated)h(with)f Fl(safe)p Fr(,)g(other)g(Hask)
o(ell)g(threads)h(in)f(the)g(pro-)2215 1727 y(gram)21
b(will)e(continue)j(to)e(run)h(unimpeded.)29 b(This)20
b(is)g(not)h(necessarily)2215 1810 y(true)f(if)g(a)g(Hask)o(ell)g
(thread)h(in)m(v)o(ok)o(es)g(a)f Fl(foreign)h(import)f
Fr(annotated)2215 1893 y(with)f Fl(unsafe)p Fr(.)2215
2013 y(Notice)30 b(that)f Fl(unsafe)i Fr(calls)e(are)h(not)g
Fq(r)m(equir)m(ed)j Fr(to)d(block)g(Hask)o(ell)2215 2096
y(threads)j(if)e(the)h(foreign)h(call)e(blocks;)40 b(instead)32
b(the)g(beha)o(viour)h(is)2215 2179 y(unspeci\002ed.)44
b(In)26 b(particular)m(,)h(it)e(is)g(le)o(gitimate)g(for)g(a)h(simple,)
h(lo)n(w-)2215 2262 y(performance)32 b(implementation)g(to)e(implement)
h Fl(unsafe)g Fr(calls)g(as)2215 2345 y Fl(safe)19 b
Fr(calls.)2049 2466 y Fk(F)n(or)o(eign)g(export.)41 b
Fr(In)m(v)o(oking)55 b(a)f(function)h(declared)g(with)e
Fl(foreign)2215 2549 y(export)27 b Fr(creates)f(a)g(ne)n(w)h(Hask)o
(ell)g(thread)f(which)h(is)f(bound)i(to)e(the)2215 2632
y(OS)18 b(thread)i(making)f(the)g(call.)2049 2752 y Fk(The)f(main)h
(thr)o(ead.)40 b Fr(In)19 b(a)f(complete,)h(standalone)g(Hask)o(ell)g
(program,)g(the)2215 2835 y(system)35 b(should)h(run)e
Fl(Main.main)i Fr(in)e(a)h(bound)h(Hask)o(ell)f(thread,)2215
2918 y(whose)19 b(associated)h(OS)e(thread)h(is)g(the)g(main)g(OS)f
(thread)h(of)g(the)g(pro-)2215 3001 y(gram.)k(It)c(is)f(as)h(if)g(the)g
(program)g(contained)i(the)e(declaration)2291 3103 y
Fl(foreign)39 b(export)g(ccall)g("haskellMain")2406 3186
y(Main.main)g(::)f(IO)g(\(\))2215 3288 y Fr(and)d(the)g(Hask)o(ell)g
(program)g(w)o(as)g(started)g(from)f(C)h(by)g(in)m(v)o(oking)2215
3371 y Fl(haskellMain\(\))p Fr(.)2049 3562 y Fs(4.2)99
b(Deri)o(v)o(ed)26 b(combinators)2049 3729 y Fr(Gi)n(v)o(en)f(the)g
(basic)h(functionality)f(outlined)h(abo)o(v)o(e,)h(we)e(can)g(de\002ne)
g(some)2049 3812 y(useful)c(combinators.)31 b(These)21
b(are)g(pro)o(vided)h(to)f(the)g(programmer)h(via)f(the)2049
3895 y Fl(Control.Concurrent)g Fr(library)-5 b(.)2049
4077 y Fj(4.2.1)90 b Fi(forkOS)2049 4244 y Fr(The)19
b Fl(forkOS)g Fr(function)h(has)f(the)g(same)g(type)h(as)f
Fl(forkIO)p Fr(:)2049 4407 y Fl(forkOS)39 b(::)f(IO)g(\(\))h(->)f(IO)g
(ThreadId)2049 4570 y Fr(Lik)o(e)21 b Fl(forkIO)p Fr(,)g(it)f(also)i
(creates)f(a)g(ne)n(w)g(Hask)o(ell)g(thread,)h(b)o(ut)f(additionally)
2049 4653 y(it)h(creates)i(a)f(ne)n(w)g(OS)g(thread)g(and)h(binds)g
(the)f(ne)n(w)h(Hask)o(ell)f(thread)h(to)f(it.)2049 4736
y(This)16 b(is)g(accomplished)j(by)e(simply)g(making)g(a)g(foreign)g
(call)f(to)h(an)f(e)o(xternal)2049 4819 y(function)22
b(that)f(\(a\))g(creates)g(the)g(ne)n(w)h(OS)e(thread,)i(and)g(\(b\))f
(in)g(the)g(ne)n(w)h(OS)2049 4902 y(thread,)h(in)m(v)o(ok)o(es)g(the)f
(requested)g(action)h(via)f(a)f(callback,)i(thus)g(creating)f(a)2049
4985 y(ne)n(w)d(bound)i(Hask)o(ell)e(thread.)2049 5151
y(W)-6 b(e)31 b(gi)n(v)o(e)h(the)f(implementation)h(of)g
Fl(forkOS)f Fr(belo)n(w)h(for)f(reference,)k(al-)2049
5234 y(though)30 b(we)e(ha)o(v)o(e)h(not)f(introduced)i(all)e(of)h(the)
f(concepts)i(used)f(in)f(it.)51 b(It)2049 5317 y(assume)26
b(the)f(e)o(xistence)h(of)f(an)h(e)o(xternal)f(function)h
Fl(createOSThread)h Fr(to)2049 5400 y(create)21 b(the)g(OS)f(thread;)i
(its)e(implementation)i(is)e(simple,)h(b)o(ut)g(depends)h(on)1931
5649 y(4)p eop
%%Page: 5 5
5 4 bop -150 83 a Fr(the)19 b(particular)g(thread)h(creation)f(primiti)
n(v)o(es)g(used)h(on)g(the)f(current)g(operat-)-150 166
y(ing)g(system.)-150 332 y Fl(forkOS)39 b(action)f(=)h(do)2
415 y(mv)g(<-)f(newEmptyMVar)2 498 y(entry)h(<-)f(wrapIO)h($)f(do)460
581 y(t)g(<-)g(myThreadId)460 664 y(putMVar)h(mv)f(t)460
747 y(action)2 830 y(createOSThread)i(entry)2 913 y(tid)f(<-)f
(takeMVar)h(mv)2 996 y(freeHaskellFunPtr)h(entry)2 1079
y(return)f(tid)-150 1245 y(foreign)g(import)g(ccall)f("createOSThread")
-74 1328 y(createOSThread)i(::)e(FunPtr)h(\(IO)f(\(\)\))h(->)f(IO)g
(\(\))-150 1411 y(foreign)h(import)g(ccall)f("wrapper")-74
1494 y(wrapIO)h(::)f(IO)h(\(\))f(->)g(FunPtr)h(\(IO)f(\(\)\))-150
1684 y Fj(4.2.2)90 b Fi(runInBoundThread)-150 1851 y
Fr(The)15 b Fl(runInBoundThread)i Fr(combinator)g(runs)f(a)f
(computation)i(in)e(a)g(bound)-150 1934 y(thread.)35
b(If)22 b(the)h(current)g(thread)g(is)g(bound,)h(then)g(that)e(is)g
(used;)j(otherwise)-150 2017 y(a)e(ne)n(w)h(bound)h(thread)e(is)g
(created)h(for)f(the)g(purpose.)38 b(The)23 b(combinator)h(is)-150
2100 y(useful)16 b(when)h(the)f(program)h(is)e(about)i(to)f(mak)o(e)g
(a)g(group)h(of)f(related)g(foreign)-150 2183 y(calls)j(that)f(must)h
(all)g(be)g(made)h(in)e(the)h(same)h(OS)e(thread.)-150
2349 y(The)h(implementation)h(is)e(straightforw)o(ard:)-150
2515 y Fl(runInBoundThread)40 b(::)e(IO)g(a)h(->)f(IO)g(a)-150
2598 y(runInBoundThread)i(action)f(=)f(do)2 2681 y(bound)h(<-)f
(isCurrentThreadBound)2 2764 y(if)h(bound)155 2847 y(then)f(action)155
2930 y(else)g(do)307 3013 y(mv)h(<-)f(newEmptyMVar)307
3096 y(forkOS)h(\(action)g(>>=)f(putMVar)h(mv\))307 3179
y(takeMVar)g(mv)-150 3345 y Fr(Note)26 b(that)h Fl(runInBoundThread)h
Fr(does)f(not)g(return)f(until)g(the)h Fl(IO)f Fr(action)-150
3428 y(completes.)-150 3627 y Fs(5)99 b(Operational)25
b(Semantics)-150 3794 y Fr(In)20 b(order)g(to)g(mak)o(e)h(the)f(design)
g(for)g(our)g(language)i(e)o(xtension)f(precise,)f(we)-150
3877 y(no)n(w)g(gi)n(v)o(e)g(an)f(operational)i(semantics)f(for)f
(Concurrent)h(Hask)o(ell)g(with)f(the)-150 3960 y(FFI)27
b(and)j(bound)g(threads.)53 b(The)29 b(operational)h(semantics)f(is)f
(highly)i(ab-)-150 4043 y(stract:)37 b(it)25 b(does)i(not)f(model)g(an)
o(y)h(details)f(of)g(actual)g(computation)h(at)f(all.)-150
4126 y(Instead,)18 b(it)g(models)h(only)f(the)g(operations)h(and)g
(interactions)g(we)f(are)g(inter)o(-)-150 4209 y(ested)h(in:)-63
4375 y Fp(\017)42 b Fr(The)21 b(running)i(system)f(consists)f(of)h(a)f
(pool)h(of)f(nati)n(v)o(e)h(\(OS\))e(threads)16 4458
y(and)g(a)e(pool)i(of)f(Hask)o(ell)g(threads.)-63 4578
y Fp(\017)42 b Fr(Hask)o(ell)15 b(threads)g(may)g(fork)g(ne)n(w)g(Hask)
o(ell)f(threads)i(\()p Fl(forkIO)p Fr(\),)e(mak)o(e)16
4661 y(foreign)20 b(calls,)e(and)h(perform)h(unspeci\002ed)g
Fl(IO)f Fr(operations.)-63 4781 y Fp(\017)42 b Fr(Nati)n(v)o(e)21
b(threads)g(ha)o(v)o(e)f(an)h(identi\002er)f(and)h(a)g(stack.)28
b(A)20 b(nati)n(v)o(e)h(thread)16 4865 y(may)f(be)g(currently)h(e)o(x)o
(ecuting)f(Hask)o(ell)g(code)h(or)f(foreign)g(code,)h(de-)16
4948 y(pending)e(on)g(what)f(is)f(on)h(top)g(of)g(the)g(stack.)23
b(Nati)n(v)o(e)18 b(threads)g(e)o(x)o(ecut-)16 5031 y(ing)k(foreign)f
(code)i(may)e(mak)o(e)i(a)e(call)g(to)g(Hask)o(ell)h(code,)g(creating)g
(a)16 5114 y(ne)n(w)d(Hask)o(ell)h(thread.)-63 5234 y
Fp(\017)42 b Fr(The)17 b(semantics)h(models)g(the)f(relationship)h
(between)g(nati)n(v)o(e)g(threads)16 5317 y(and)28 b(Hask)o(ell)g
(threads,)i(and)f(the)e(dif)n(ference)i(between)f(bound)h(and)16
5400 y(unbound)21 b(Hask)o(ell)e(threads.)2049 83 y(Further)k(rele)n(v)
n(ant)h(semantics)g(for)f Fl(IO)g Fr(code)h(in)f(Hask)o(ell)g(can)h(be)
g(found)g(in)2049 166 y(Pe)o(yton)h(Jones')g(\223T)-6
b(ackling)25 b(the)f(A)-7 b(wkw)o(ard)26 b(Squad\224[9)q(])e(and)h(the)
g(original)2049 249 y(Concurrent)20 b(Hask)o(ell)f(paper[10)r(].)2049
415 y(The)i(syntax)i(of)e(a)h(nati)n(v)o(e)f(thread)h(is)f(gi)n(v)o(en)
i(in)e(Figure)g(1.)31 b(A)21 b(nati)n(v)o(e)h(thread)2049
498 y(of)k(form)h Fq(N)t Fg([)p Fq(S)q Fg(])f Fr(has)h(thread)f
(identi\002er)g Fq(N)t Fr(,)j(while)d Fq(S)h Fr(is)f(an)h(abstraction)g
(of)2049 581 y(its)e(call)g(stack.)43 b(If)25 b Fq(H)30
b Fr(is)c(on)f(top)h(of)g(the)f(stack,)i(the)f(thread)g(is)f(willing)g
(to)2049 664 y(e)o(x)o(ecute)17 b(a)g(Hask)o(ell)g(thread.)23
b(If)16 b Fq(F)2931 637 y Fe(si)2990 664 y Fq(h)h Fr(is)f(on)i(top)f
(of)f(the)h(stack,)g(the)g(thread)g(is)2049 747 y(in)e(the)h(process)g
(of)f(dealing)h(with)f(a)h(call)f(to)g(a)g(foreign)h(function,)h(which)
f(will)2049 830 y(return)24 b(its)g(result)g(to)g(the)g(Hask)o(ell)h
(thread)f Fq(h)p Fr(.)39 b(The)24 b(safety)h(of)f(the)g(foreign)2049
913 y(call)d(is)g(gi)n(v)o(en)h(by)g Fq(si)p Fr(,)g(which)g(is)f
(either)g Fq(u)h Fr(meaning)g(unsafe,)h(or)e Fq(s)h Fr(meaning)2049
996 y(safe.)2049 1162 y(A)29 b(nati)n(v)o(e)g(thread)g(of)g(the)g(form)
g Fq(N)t Fg([)p Fp(\017)p Fg(])g Fr(is)f(a)h(thread)g(which)h
(originates)f(in)2049 1245 y(foreign)f(code;)33 b(it)27
b(does)h(not)g(ha)o(v)o(e)f(an)o(y)i(Hask)o(ell)e(calls)h(an)o(ywhere)g
(on)g(its)2049 1328 y(stack.)2049 1494 y(A)23 b(nati)n(v)o(e)h(thread)g
(of)g(form)f Fq(N)t Fg([)p Fq(H)5 b Fg(])24 b Fr(has)g(a)f(stack)h
(that)f(e)o(xists)h(only)g(to)f(serv)o(e)2049 1577 y(Hask)o(ell)e
(threads,)g(and)g(so)g(can)g(safely)g(block)g(inside)g(a)f(foreign)h
(call)f(with-)2049 1660 y(out)h(impeding)g(other)g(Hask)o(ell)g
(threads.)28 b(W)-6 b(e)20 b(call)g(these)h(threads)g(\223w)o(ork)o(er)
2049 1743 y(threads\224.)2049 1910 y(The)29 b(syntax)i(of)e(a)h(Hask)o
(ell)f(thread)h(is)f(gi)n(v)o(en)i(in)e(Figure)g(2.)55
b(A)29 b(Hask)o(ell)2049 1993 y(thread)24 b Fq(h)f Fr(of)g(form)g
Fg(\()p Fq(a)p Fg(\))2667 2005 y Fe(N)2737 1993 y Fr(has)g(action)h
Fq(a)p Fr(.)36 b(The)23 b(indicator)h Fq(N)j Fr(identi\002es)c(the)2049
2076 y(nati)n(v)o(e)c(thread)h Fq(N)j Fr(to)c(which)g(the)g(Hask)o(ell)
g(thread)g(is)g Fq(bound)p Fr(.)2049 2242 y(An)k(action)g
Fq(a)g Fr(is)g(a)f(sequence)j(of)e(operations,)h(\002nishing)f(with)g
(a)g(return)g(of)2049 2325 y(some)17 b(kind.)23 b(An)16
b(operation)h(is)f(either)g(an)h(unspeci\002ed)h Fl(IO)e
Fr(operation)h(\(such)2049 2408 y(as)k(performing)i(some)f(e)n(v)n
(aluation,)h(or)e(operating)h(on)g(an)g Fl(MVar)p Fr(\),)g(a)f(call)g
(to)2049 2491 y(the)e(primiti)n(v)o(e)g Fl(forkIO)p Fr(,)g(or)g(a)f
(call)h(to)g(a)g(foreign)g(function)31 b Fq(f)11 b Fr(.)2049
2657 y(W)-6 b(e)15 b(do)i(not)f(model)g(the)g(data)g(passed)h(to,)f(or)
g(returned)g(from,)g(a)g(foreign)g(call,)2049 2740 y(nor)j(an)o(y)h
(details)f(of)f(what)h(the)g Fl(IO)g Fr(operations)h(are.)2049
2906 y(Note)i(that)g Fl(forkOS)h Fr(is)f(not)g(mentioned)i(alongside)f
Fl(forkIO)g Fr(here.)33 b(While)2049 2989 y(spa)o(wning)20
b(a)f(ne)n(w)g(unbound)i(thread)e(requires)h(direct)e(support)i(by)g
(the)f(run-)2049 3072 y(time)g(system,)h(creating)g(a)g(ne)n(w)g(bound)
i(thread)e(is)f(done)i(by)f(making)h(a)e(for)o(-)2049
3155 y(eign)d(call)e(to)h(the)g(operating)h(system-pro)o(vided)h
(thread)f(creation)f(primiti)n(v)o(e.)2049 3238 y(Therefore,)k
Fl(forkOS)g Fr(need)g(not)g(be)h(considered)g(when)f(we)g(discuss)g
(the)g(se-)2049 3321 y(mantics.)2049 3516 y Fs(5.1)99
b(Ev)o(olution)2049 3683 y Fr(The)23 b(symbol)i Fn(N)41
b Fr(refers)23 b(to)g(a)h(set)f(of)g(nati)n(v)o(e)h(threads,)h(and)f
Fn(H)40 b Fr(to)23 b(a)h(set)f(of)2049 3766 y(Hask)o(ell)h(threads.)38
b(An)23 b(e)o(x)o(ecuting)i(program)f(consists)g(of)g(a)f(combination)
2049 3849 y(of)c(the)g(tw)o(o,)g(written)f Fn(N)g Fr(;)8
b Fn(H)16 b Fr(.)2049 4015 y(W)-6 b(e)21 b(describe)g(ho)n(w)h(the)f
(system)g(e)n(v)o(olv)o(es)h(in)f(a)g(v)o(ery)g(standard)h(w)o(ay)-5
b(,)22 b(using)2049 4098 y(transition)d(rules,)g(of)g(form)2777
4233 y Fn(N)f Fr(;)8 b Fn(H)52 b Fp(\))35 b Fn(N)3179
4202 y Fd(0)3199 4233 y Fr(;)8 b Fn(H)3302 4202 y Fd(0)2049
4368 y Fr(The)19 b(structural)g(rules)g(are)g(these:)2260
4490 y Fn(N)e Fr(;)8 b Fn(H)53 b Fp(\))35 b Fn(N)2661
4462 y Fd(0)2681 4490 y Fr(;)8 b Fn(H)2784 4462 y Fd(0)p
2091 4524 883 4 v 2091 4601 a Fn(N)28 b Fp([)10 b(f)n
Fq(t)5 b Fp(g)p Fr(;)j Fn(H)53 b Fp(\))35 b Fn(N)2661
4573 y Fd(0)2692 4601 y Fp([)10 b(f)n Fq(t)5 b Fp(g)p
Fr(;)j Fn(H)2953 4573 y Fd(0)3306 4490 y Fn(N)17 b Fr(;)8
b Fn(H)52 b Fp(\))35 b Fn(N)3707 4462 y Fd(0)3727 4490
y Fr(;)8 b Fn(H)3830 4462 y Fd(0)p 3123 4524 910 4 v
3123 4601 a Fn(N)18 b Fr(;)8 b Fn(H)27 b Fp([)10 b(f)p
Fq(h)p Fp(g)36 b(\))f Fn(N)3707 4573 y Fd(0)3727 4601
y Fr(;)8 b Fn(H)3830 4573 y Fd(0)3860 4601 y Fp([)i(f)p
Fq(h)p Fp(g)2049 4820 y Fr(These)30 b(standard)g(rules)g(allo)n(w)f(us)
h(to)f(write)g(the)h(interesting)g(transitions)2049 4903
y(with)c(less)g(clutter)l(.)46 b(The)26 b(transition)h(rules)f(for)h
(the)f(system)h(are)g(gi)n(v)o(en)g(in)2049 4986 y(Figure)19
b(3.)2049 5152 y(W)-6 b(e)18 b(informally)i(describe)f(each)h(rule)f
(in)f(the)h(semantics)h(belo)n(w:)2049 5317 y Fk(IO)42
b Fr(A)19 b(Hask)o(ell)i(thread)f(may)h(perform)f(an)g(arbitrary)g
Fl(IO)g Fr(operation.)28 b(Note)2215 5400 y(that)e(we)f(only)i(require)
f(that)g(there)g(is)f(one)i(nati)n(v)o(e)f(thread)g(ready)h(to)1931
5649 y(5)p eop
%%Page: 6 6
6 5 bop -178 111 4257 4 v -178 1031 4 920 v 963 252 a
Fr(Nati)n(v)o(e)19 b(thread)108 b Fq(t)88 b Fr(::)p Fg(=)82
b Fq(N)t Fg([)p Fq(S)q Fg(])963 418 y Fr(Stack)331 b
Fq(S)84 b Fr(::)p Fg(=)e Fo(e)293 b Fr(Empty)1620 501
y Fp(j)122 b Fq(H)22 b Fr(:)16 b Fq(S)176 b Fr(Ex)o(ecuting)20
b(Hask)o(ell)1620 591 y Fp(j)122 b Fq(F)1815 563 y Fe(si)1877
591 y Fq(h)17 b Fr(:)f Fq(S)84 b Fr(Ex)o(ecuting)20 b(a)f(foreign)g
(call)1620 674 y Fp(j)122 b(\017)289 b Fr(Ex)o(ecuting)20
b(foreign)f(code)h(only)963 840 y(Call)e(Safety)151 b
Fq(si)83 b Fr(::)p Fg(=)f Fq(u)289 b Fr(Unsafe)1620 923
y Fp(j)122 b Fq(s)297 b Fr(Safe)p 4075 1031 V -178 1034
4257 4 v 1411 1102 a Fk(Figur)o(e)18 b(1:)24 b Fr(Syntax)19
b(of)g(Nati)n(v)o(e)g(Threads)p -178 1402 V -178 2488
4 1087 v 857 1544 a(Hask)o(ell)g(thread)156 b Fq(h)84
b Fr(::)p Fg(=)e(\()p Fq(a)p Fg(\))1843 1558 y Fe(b)o(t)857
1710 y Fr(Bound)20 b(thread)f(id)83 b Fq(b)n(t)89 b Fr(::)p
Fg(=)82 b Fo(e)335 b Fr(Not)19 b(bound)1605 1793 y Fp(j)122
b Fq(N)318 b Fr(Bound)20 b(to)f(nati)n(v)o(e)g(thread)h(N)857
1959 y(Hask)o(ell)f(action)160 b Fq(a)84 b Fr(::)p Fg(=)k
Fq(p)19 b Fl(>>)g Fq(a)174 b Fr(Sequence)1605 2042 y
Fp(j)122 b Fq(RE)5 b(T)229 b Fr(Return)19 b(from)g(a)g(call)g(into)g
(Hask)o(ell)857 2208 y(Operation)291 b Fq(p)83 b Fr(::)p
Fg(=)f Fo(t)335 b Fl(IO)19 b Fr(operation)1605 2291 y
Fp(j)122 b Fl(forkIO)20 b Fq(a)83 b Fr(F)o(ork)19 b(a)g(thread)1605
2381 y Fp(j)122 b Fq(F)1800 2353 y Fe(si)1873 2381 y
Fq(f)222 b Fr(F)o(oreign)19 b(call)p 4075 2488 V -178
2491 4257 4 v 1396 2560 a Fk(Figur)o(e)f(2:)23 b Fr(Syntax)c(of)g(Hask)
o(ell)h(Threads)p -178 2860 V -178 5205 4 2345 v 984
3001 a Fq(N)t Fg([)p Fq(H)i Fr(:)17 b Fq(S)q Fg(])p Fr(;)8
b Fg(\()p Fo(t)18 b Fl(>>)h Fq(a)p Fg(\))1502 3015 y
Fe(b)o(t)1637 3001 y Fp(\))83 b Fq(N)t Fg([)p Fq(H)21
b Fr(:)c Fq(S)q Fg(])p Fr(;)8 b Fg(\()p Fq(a)p Fg(\))2166
3015 y Fe(b)o(t)2783 3001 y Fg(\()p Fq(I)t(O)p Fg(\))733
3168 y Fq(N)t Fg([)p Fq(H)21 b Fr(:)c Fq(S)q Fg(])p Fr(;)8
b Fg(\()p Fl(forkIO)19 b Fq(b)g Fl(>>)g Fq(a)p Fg(\))1502
3182 y Fe(b)o(t)1637 3168 y Fp(\))83 b Fq(N)t Fg([)p
Fq(H)21 b Fr(:)c Fq(S)q Fg(])p Fr(;)8 b Fg(\()p Fq(a)p
Fg(\))2166 3182 y Fe(b)o(t)2218 3168 y Fh(;)g Fg(\()p
Fq(b)p Fg(\))2342 3179 y Ff(e)2783 3168 y Fg(\()p Fq(F)e(ORK)t(I)t(O)p
Fg(\))866 3340 y Fq(N)t Fg([)p Fq(H)22 b Fr(:)16 b Fq(S)q
Fg(])p Fr(;)8 b Fg(\()p Fq(F)1223 3313 y Fe(si)1296 3340
y Fq(f)29 b Fl(>>)19 b Fq(a)p Fg(\))1507 3352 y Fe(N)1637
3340 y Fp(\))83 b Fq(N)t Fg([)p Fq(F)1922 3313 y Fe(si)1983
3340 y Fg(\()p Fq(a)p Fg(\))2078 3352 y Fe(N)2142 3340
y Fr(:)16 b Fq(H)22 b Fr(:)16 b Fq(S)q Fg(])p Fr(;)411
b Fg(\()p Fq(F)r(C)r(ALL)p Fr(1)p Fg(\))975 3430 y Fq(N)t
Fg([)p Fq(H)5 b Fg(])p Fr(;)j Fg(\()p Fq(F)1240 3403
y Fe(si)1312 3430 y Fq(f)30 b Fl(>>)19 b Fq(a)p Fg(\))1524
3441 y Ff(e)1637 3430 y Fp(\))83 b Fq(N)t Fg([)p Fq(F)1922
3403 y Fe(si)1983 3430 y Fg(\()p Fq(a)p Fg(\))2078 3441
y Ff(e)2125 3430 y Fr(:)16 b Fq(H)5 b Fg(])p Fr(;)520
b Fg(\()p Fq(F)r(C)r(ALL)p Fr(2)p Fg(\))1143 3603 y Fq(N)t
Fg([)p Fq(F)1270 3576 y Fe(si)1331 3603 y Fq(a)1368 3617
y Fe(b)o(t)1437 3603 y Fr(:)16 b Fq(S)q Fg(])p Fr(;)83
b Fp(\))g Fq(N)t Fg([)p Fq(S)q Fg(])p Fr(;)8 b Fq(a)1995
3617 y Fe(b)o(t)2783 3603 y Fg(\()p Fq(F)e(RE)f(T)j Fg(\))1400
3769 y Fq(N)t Fg([)p Fp(\017)p Fg(])p Fr(;)83 b Fp(\))g
Fq(N)t Fg([)p Fq(H)21 b Fr(:)c Fp(\017)p Fg(])p Fr(;)8
b Fg(\()p Fq(a)19 b Fl(>>)g Fq(RE)5 b(T)27 b Fg(\))2445
3781 y Fe(N)2783 3769 y Fg(\()p Fq(H)q(C)r(ALL)p Fr(1)p
Fg(\))1211 3935 y Fq(N)t Fg([)p Fq(F)1338 3908 y Fe(s)1383
3935 y Fq(h)17 b Fr(:)f Fq(S)q Fg(])p Fr(;)83 b Fp(\))g
Fq(N)t Fg([)p Fq(H)21 b Fr(:)c Fq(F)2035 3908 y Fe(s)2080
3935 y Fq(h)g Fr(:)g Fq(S)q Fg(])p Fr(;)26 b Fg(\()p
Fq(a)19 b Fl(>>)g Fq(RE)5 b(T)27 b Fg(\))2653 3947 y
Fe(N)2783 3935 y Fg(\()p Fq(H)q(C)r(ALL)p Fr(2)p Fg(\))1007
4101 y Fq(N)t Fg([)p Fq(H)22 b Fr(:)16 b Fq(S)q Fg(])p
Fr(;)8 b Fg(\()p Fq(RE)d(T)28 b Fg(\))1508 4113 y Fe(N)1637
4101 y Fp(\))83 b Fq(N)t Fg([)p Fq(S)q Fg(])p Fr(;)833
b Fg(\()p Fq(H)5 b(RE)g(T)k Fg(\))1271 4267 y Fr(;)f
Fg(\()p Fq(RE)d(T)27 b Fg(\))1524 4278 y Ff(e)1637 4267
y Fp(\))83 b Fr(;)967 b Fg(\()p Fq(H)5 b(E)g(N)t(D)p
Fg(\))1264 4433 y(\()p Fq(no)n(t)g(hing)p Fg(\))85 b
Fp(\))e Fq(N)t Fg([)p Fq(H)5 b Fg(])p Fr(;)812 b Fg(\()l
Fq(W)9 b(K)t(R)p Fg(\))1637 4516 y Fr(where)19 b Fq(N)k
Fr(is)c(fresh)1378 4682 y Fq(N)t Fg([)p Fq(H)5 b Fg(])p
Fr(;)83 b Fp(\))g Fg(\()p Fq(no)n(t)5 b(hing)p Fg(\))700
b(\()l Fq(W)9 b(K)t(RE)c(N)t(D)p Fg(\))1264 4848 y(\()p
Fq(no)n(t)g(hing)p Fg(\))85 b Fp(\))e Fq(N)t Fg([)p Fp(\017)p
Fg(])p Fr(;)834 b Fg(\()p Fq(E)5 b(X)i(T)i Fg(\))1637
4931 y Fr(where)19 b Fq(N)k Fr(is)c(fresh)1400 5097 y
Fq(N)t Fg([)p Fp(\017)p Fg(])p Fr(;)83 b Fp(\))g Fg(\()p
Fq(no)n(t)5 b(hing)p Fg(\))700 b(\()p Fq(N)t(E)5 b(N)t(D)p
Fg(\))p 4075 5205 V -178 5208 4257 4 v 1453 5277 a Fk(Figur)o(e)19
b(3:)k Fr(Operational)c(Semantics)1931 5649 y(6)p eop
%%Page: 7 7
7 6 bop 16 83 a Fr(e)o(x)o(ecute)21 b(Hask)o(ell)g(code)g(\(with)e
Fq(H)26 b Fr(on)20 b(top)h(of)f(its)g(stack\).)27 b(The)20
b(nati)n(v)o(e)16 166 y(thread)e(may)h(or)e(may)i(not)f(be)g(the)g
(same)g(as)g(the)g(nati)n(v)o(e)g(thread)g(bound)16 249
y(to)h(this)g(Hask)o(ell)g(thread,)g(if)f(an)o(y)-5 b(.)-150
369 y Fk(FORKIO)42 b Fr(A)21 b(Hask)o(ell)g(thread)h(in)m(v)o(ok)o(es)g
Fl(forkIO)p Fr(,)f(gi)n(ving)h(rise)f(to)g(a)h(ne)n(w)-5
b(,)16 452 y(unbound,)21 b(Hask)o(ell)e(thread.)-150
573 y Fk(FCALL1)41 b Fr(A)23 b(bound)j(Hask)o(ell)d(thread)i(mak)o(es)f
(a)g(foreign)g(call.)37 b(The)23 b(call)16 656 y(must)36
b(be)h(made)g(in)f(the)h(nati)n(v)o(e)f(thread)h(bound)h(to)e(this)g
(Hask)o(ell)16 739 y(thread.)-150 859 y Fk(FCALL2)41
b Fr(An)26 b(unbound)h(Hask)o(ell)f(thread)g(mak)o(es)h(a)e(foreign)h
(call.)43 b(The)16 942 y(call)19 b(is)f(made)i(in)e(a)h(w)o(ork)o(er)h
(thread.)-150 1063 y Fk(FRET)41 b Fr(A)23 b(foreign)h(call)g(returns;)i
(the)d(Hask)o(ell)h(thread)g(which)g(made)h(the)16 1146
y(call)19 b(is)f(reintroduced)i(into)f(the)g(pool)h(of)f(Hask)o(ell)g
(threads.)-150 1266 y Fk(HCALL1)42 b Fr(A)30 b(nati)n(v)o(e)g(thread)h
(running)h(e)o(xclusi)n(v)o(ely)f(foreign)g(code)g(\(no)16
1349 y(Hask)o(ell)23 b(frames)h(on)f(the)h(stack\))f(mak)o(es)h(a)f
(call)g(to)g(a)g(Hask)o(ell)g(func-)16 1432 y(tion.)g(A)c(ne)n(w)g
(bound)i(Hask)o(ell)e(thread)g(is)g(created.)-150 1553
y Fk(HCALL2)42 b Fr(A)25 b(nati)n(v)o(e)g(thread)h(currently)g(e)o(x)o
(ecuting)g(a)g Fq(safe)f Fr(foreign)h(call)16 1636 y(from)34
b(Hask)o(ell)h(in)m(v)o(ok)o(es)h(another)f(Hask)o(ell)g(function.)70
b(A)34 b(bound)16 1719 y(Hask)o(ell)19 b(thread)h(is)e(created)i(for)e
(the)h(ne)n(w)h(call.)-150 1839 y Fk(HRET)41 b Fr(A)28
b(bound)h(Hask)o(ell)f(thread)g(returns;)k(the)c(nati)n(v)o(e)g(thread)
g(which)16 1922 y(made)20 b(the)f(call)f(continues)i(from)f(the)g(call)
g(site.)-150 2042 y Fk(HEND)41 b Fr(An)19 b(unbound)j(Hask)o(ell)d
(thread)g(returns.)-150 2163 y Fk(WKR)41 b Fr(This)15
b(rule)g(models)h(the)f(birth)g(of)g(ne)n(w)g(w)o(ork)o(er)h(OS)e
(threads,)i(in)f(case)16 2246 y(the)o(y)k(should)h(all)f(be)g(block)o
(ed)h(in)f(a)g(foreign)g(call.)-150 2366 y Fk(WKREND)41
b Fr(A)19 b(w)o(ork)o(er)g(thread)h(e)o(xits.)-150 2487
y Fk(EXT)41 b Fr(A)19 b(ne)n(w)g(nati)n(v)o(e)g(thread)h(is)e(created)i
(by)f(foreign)h(code.)-150 2607 y Fk(NEND)41 b Fr(A)19
b(nati)n(v)o(e)g(thread,)g(e)o(x)o(ecuting)h(foreign)g(code)f(only)-5
b(,)20 b(e)o(xits.)-150 2777 y(In)g(a)g(e)o(x)o(ecuting)h(program,)g
(there)f(may)g(be)h(multiple)e(v)n(alid)i(transitions)f(ac-)-150
2860 y(cording)32 b(to)f(the)h(semantics)f(at)g(an)o(y)h(gi)n(v)o(en)g
(time.)59 b(W)-6 b(e)31 b(do)h(not)f(specify)-150 2943
y(which,)h(if)d(an)o(y)-5 b(,)33 b(of)c(the)h(v)n(alid)g(transitions)g
(must)f(be)h(performed)h(by)f(the)-150 3026 y(implementation.)-150
3192 y(Note)15 b(that)f(in)h(particular)g(this)g(admits)f(an)h
(implementation)h(that)f(does)g(noth-)-150 3275 y(ing)20
b(at)f(all;)g(le)o(gislating)g(against)g(such)i(beha)o(viour)f(in)f
(the)h(semantics)g(is)f(en-)-150 3358 y(tirely)26 b(non-tri)n(vial,)i
(so)f(we)f(do)h(not)g(attempt)f(it.)45 b(Rather)m(,)28
b(we)f(informally)-150 3441 y(state)19 b(the)g(beha)o(viour)h(we)e(e)o
(xpect)i(from)f(an)g(implementation:)-63 3611 y Fp(\017)42
b Fr(If)21 b(a)h(Hask)o(ell)g(thread)g(is)f(performing)i(an)f(unsafe)g
(foreign)h(call,)e(then)16 3694 y(the)c(implementation)g(is)f(allo)n
(wed)h(to)f(refrain)h(from)f(making)h(an)o(y)g(fur)o(-)16
3777 y(ther)i(transitions)g(until)g(the)g(call)f(returns.)-63
3897 y Fp(\017)42 b Fr(If)23 b(a)g(Hask)o(ell)h(thread)g(is)f
(performing)i(a)e(safe)h(call,)f(then)h(the)g(imple-)16
3981 y(mentation)17 b(should)h(continue)g(to)e(mak)o(e)i(v)n(alid)f
(transitions)g(in)f(respect)16 4064 y(of)j(other)g(Hask)o(ell)g
(threads)h(in)f(the)g(system.)-63 4184 y Fp(\017)42 b
Fr(The)21 b(implementation)h(should)h(not)e(otherwise)h
Fq(starve)g Fr(an)o(y)f(Hask)o(ell)16 4267 y(threads.)-150
4437 y(T)m(ransitions)h(which)g(are)f(not)h(part)f(of)g(this)h
(semantics)f(are)h(erroneous.)32 b(An)-150 4520 y(implementation)22
b(may)f(either)f(detect)h(an)g(report)g(the)g(error)m(,)g(or)f(it)g
(may)i(be-)-150 4603 y(ha)o(v)o(e)16 b(in)g(some)h(other)f
(implementation-de\002ned)i(manner)l(.)23 b(An)16 b(application)-150
4686 y(which)21 b(depends)h(on)f(implementation-de\002ned)i(beha)o
(viour)e(is,)g(of)f(course,)-150 4769 y(non-portable.)-150
4984 y Fs(6)99 b(Implementation)-150 5151 y Fr(In)25
b(this)g(section,)h(we)f(will)f(outline)i(three)f(dif)n(ferent)g
(implementations)h(of)-150 5234 y(the)21 b(language)i(e)o(xtensions)f
(described)h(in)e(this)g(paper)l(.)31 b(The)21 b(third)g(of)g(these)
-150 5317 y(has)k(been)g(implemented)g(in)f(the)h(Glasgo)n(w)g(Hask)o
(ell)f(Compiler;)j(it)d(is)g(the)-150 5400 y(most)19
b(comple)o(x)h(of)f(the)g(three,)g(b)o(ut)f(it)g(pro)o(vides)i(the)f
(best)g(performance.)2049 83 y(W)-6 b(e)28 b(will)g(also)h(describe)g
(the)g(issue)g(of)f(I/O)g(multiple)o(xing,)k(i.e.)52
b(ho)n(w)29 b(to)2049 166 y(transparently)c(speed)f(up)h(I/O)e(be)o
(yond)i(the)f(le)n(v)o(els)g(attainable)g(using)h(safe)2049
249 y(foreign)19 b(calls.)2049 441 y Fs(6.1)99 b(One)25
b(OS)g(Thr)n(ead)i(f)n(or)d(one)i(Hask)o(ell)e(Thr)n(ead)2049
608 y Fr(A)18 b(v)o(ery)h(simple)g(and)g(straightforw)o(ard)g
(implementation)h(w)o(ould)f(be)g(to)f(use)2049 691 y(the)25
b(operating)h(system)f(supplied)h(thread)f(library)g(to)g(create)g(e)o
(xactly)g(one)2049 774 y(OS)18 b(thread)i(for)e(each)i(thread)f(in)g
(the)g(system.)2049 940 y(In)24 b(such)h(an)g(implementation,)h(there)f
(is)f(no)g(distinction)h(between)g(bound)2049 1023 y(and)36
b(unbound)i(threads;)45 b(e)n(v)o(ery)36 b(thread)g(can)g(be)g
(considered)i(a)d(bound)2049 1106 y(thread.)22 b(This)14
b(is)g(entirely)h(in)f(accordance)i(with)e(the)h(operational)g
(semantics)2049 1189 y(outlined)22 b(in)g(Section)g(5.)31
b(Only)22 b(three)g(of)f(the)h(rules)g(\(FORKIO,)e(FCALL2)2049
1273 y(and)26 b(HEND\))f(e)o(xplicitly)g(refer)g(to)h(unbound)i(Hask)o
(ell)d(threads;)30 b(it')l(s)24 b(easy)2049 1356 y(to)19
b(see)g(that)f(nothing)i(in)f(these)g(rules)f(pre)n(v)o(ents)i(each)f
(Hask)o(ell)h(thread)f(from)2049 1439 y(ha)o(ving)h(its)e(dedicated)i
(OS)e(thread.)2049 1605 y(In)41 b(Section)g(4.1,)47 b(we)41
b(de\002ned)h(that)f Fl(isCurrentThreadBound)i Fr(may)2049
1688 y(return)57 b Fl(True)g Fr(whene)n(v)o(er)h(the)f(calling)h(Hask)o
(ell)f(thread)g(is)g(indis-)2049 1771 y(tinguishable)52
b(from)f(a)f(bound)j(thread;)66 b(we)51 b(can)g(therefore)g(de\002ne)
2049 1854 y Fl(isCurrentThreadBound)40 b(=)e(return)h(True)p
Fr(,)21 b(and)g(we)g(do)g(not)f(need)i(to)2049 1937 y(k)o(eep)e(track)f
(of)g(ho)n(w)g(Hask)o(ell)h(threads)f(were)g(created.)2049
2103 y(Concurrent)33 b(Hask)o(ell')l(s)g(thread)f(creation)h(and)g
(synchronisation)h(primi-)2049 2186 y(ti)n(v)o(es)f(are)h(simply)f
(mapped)i(to)e(the)h(corresponding)h(operating)f(system)2049
2269 y(functions.)23 b(The)17 b Fl(forkIO)g Fr(primiti)n(v)o(e)g(can)g
(be)g(implemented)h(the)f(same)g(w)o(ay)2049 2352 y(as)i
Fl(forkOS)p Fr(.)2049 2518 y(The)j(only)h(challenge)g(is)e(managing)j
(access)f(to)e(the)i(heap;)h(it)d(is)h(v)o(ery)g(hard)2049
2601 y(to)g(support)h(truly)f(simultaneous)h(multithreaded)g(Hask)o
(ell)f(e)o(x)o(ecution)h(\(on)2049 2684 y(SMP)14 b(systems\),)i(so)f
(it)f(will)g(be)h(necessary)h(to)f(ha)o(v)o(e)g(a)g(global)g(mutual)g
(e)o(xclu-)2049 2767 y(sion)g(lock)h(that)f(pre)n(v)o(ents)h(more)f
(than)g(one)h(thread)f(from)g(e)o(x)o(ecuting)h(Hask)o(ell)2049
2850 y(code)k(at)e(the)h(same)h(time.)2049 3016 y(This)27
b(global)i(lock)f(w)o(ould)h(ha)o(v)o(e)f(to)f(be)h(released)h
(periodically)f(to)g(allo)n(w)2049 3099 y(other)22 b(threads)g(to)f
(run;)h(it)f(w)o(ould)h(also)g(ha)o(v)o(e)f(to)g(be)h(released)g(for)f
(safe)g(for)o(-)2049 3182 y(eign)e(calls.)2049 3348 y(Incidentally)-5
b(,)35 b(this)c(is)g(e)o(xactly)g(the)h(strate)o(gy)f(used)h(by)g(the)f
(nati)n(v)o(e-code)2049 3431 y(O'Caml)18 b(implementation)i(\(see)f
(Section)g(7.2\).)2049 3623 y Fs(6.2)99 b(All)24 b(Hask)o(ell)g(Thr)n
(eads)j(in)e(one)g(OS)g(Thr)n(ead)2049 3790 y Fr(The)e(second)h
(approach)h(is)e(to)f(e)o(xtend)i(the)f(fully)g(multiple)o(x)o(ed)h
(scheme)g(to)2049 3873 y(include)h(bound)h(threads.)41
b(This)24 b(is)g(a)g(natural)h(e)o(xtension)g(for)g(an)f(e)o(xisting)
2049 3956 y(single-threaded)c(Hask)o(ell)f(implementation)h(where)f
(performance)h(of)e(for)o(-)2049 4039 y(eign)h(calls)g(is)g(not)g
(critical.)2049 4205 y(A)24 b(single)g(OS)f(thread)h(\(the)g(Hask)o
(ell)g(e)o(x)o(ecution)h(thread\))f(is)g(allocated)g(for)2049
4288 y(the)16 b(Hask)o(ell)f(system,)i(and)f(is)f(used)h(e)o(xclusi)n
(v)o(ely)h(to)e(e)o(x)o(ecute)h(Hask)o(ell)g(code.)2049
4372 y(All)i(Hask)o(ell)h(threads)h(are)f(multiple)o(x)o(ed)g(using)h
(this)e(OS)h(thread.)2049 4538 y(Additionally)-5 b(,)19
b(the)g(Hask)o(ell)g(e)o(x)o(ecution)h(thread)g(must)f(k)o(eep)h(track)
f(of:)2136 4702 y Fp(\017)42 b Fr(An)o(y)21 b(OS)f(threads)h(which)f
(ha)o(v)o(e)h(made)g(in-calls.)28 b(Each)20 b(of)h(these)f(has)2215
4785 y(gi)n(v)o(en)g(rise)e(to)h(a)g(bound)h(Hask)o(ell)g(thread.)2136
4905 y Fp(\017)42 b Fr(A)19 b(pool)h(of)g(OS)e(threads)i(that)f(can)h
(be)g(used)g(to)f(mak)o(e)h(\223safe\224)g(foreign)2215
4988 y(calls.)2049 5153 y(When)27 b(a)h(Hask)o(ell)f(thread)h(mak)o(es)
g(an)g(out-call,)h(there)e(are)h(tw)o(o)f(cases)h(to)2049
5236 y(consider:)2136 5400 y Fp(\017)42 b Fr(The)27 b(Hask)o(ell)f
(thread)h(is)g(bound.)47 b(The)27 b(Hask)o(ell)g(e)o(x)o(ecution)g
(thread)1931 5649 y(7)p eop
%%Page: 8 8
8 7 bop 16 83 a Fr(must)21 b(pass)h(a)f(message)h(to)e(the)i
(appropriate)g(OS)e(thread)h(in)g(order)h(to)16 166 y(mak)o(e)28
b(the)g(call,)h(and)f(the)g(OS)f(thread)h(must)f(return)h(the)f(result)
h(via)16 249 y(another)20 b(message)g(back)f(to)g(the)g(Hask)o(ell)g(e)
o(x)o(ecution)h(thread.)-63 369 y Fp(\017)42 b Fr(The)24
b(Hask)o(ell)h(thread)g(is)f(unbound.)41 b(The)25 b(situation)f(is)g
(similar)m(,)h(e)o(x-)16 452 y(cept)17 b(that)f(the)g(OS)g(thread)h(to)
f(mak)o(e)h(the)g(call)f(can)h(be)g(dra)o(wn)f(from)h(the)16
535 y(pool.)-150 698 y(The)i(complicated)i(part)e(of)g(this)g
(implementation)i(is)e(the)g(passing)h(of)g(mes-)-150
781 y(sages)35 b(between)f(OS)g(threads)g(to)g(mak)o(e)h(foreign)f
(calls)g(and)h(return)f(re-)-150 864 y(sults:)26 b(essentially)21
b(this)f(is)g(a)g(remote)h(procedure)h(call)e(mechanism.)29
b(Ho)n(w-)-150 947 y(e)n(v)o(er)m(,)i(if)c(the)h(Hask)o(ell)h(system)f
(is)g(an)h(interpreter)m(,)h(it)d(may)i(already)g(ha)o(v)o(e)-150
1030 y(support)h(for)f(making)i(dynamic)f(foreign)g(calls)f(in)g(order)
h(to)f(implement)-150 1113 y Fl(foreign)39 b(import)p
Fr(.)-150 1279 y(A)28 b(compiled)h(implementation)g(is)f(unlik)o(ely)i
(to)e(w)o(ant)g(use)h(this)f(scheme,)-150 1363 y(due)21
b(to)f(the)g(e)o(xtra)g(o)o(v)o(erhead)i(on)e(foreign)h(calls.)26
b(F)o(or)20 b(an)g(interpreter)m(,)g(ho)n(w-)-150 1446
y(e)n(v)o(er)m(,)d(this)g(implementation)h(strate)o(gy)f(may)g(be)h
(less)e(complicated)i(than)g(the)-150 1529 y(hybrid)h(scheme)h
(discussed)g(in)f(the)g(ne)o(xt)g(section.)-150 1720
y Fs(6.3)99 b(GHC')l(s)24 b(Implementation)-150 1886
y Fr(GHC')l(s)j(run-time)h(system)g(emplo)o(ys)i(one)e(OS)f(thread)i
(for)f(e)n(v)o(ery)g(bound)-150 1969 y(thread;)61 b(additionally)-5
b(,)54 b(there)46 b(is)h(a)f(v)n(ariable)h(number)h(of)e(so-called)-150
2052 y(\223w)o(ork)o(er\224)k(OS)e(threads)h(that)g(are)f(used)i(to)e
(e)o(x)o(ecute)i(the)e(unbound)-150 2135 y(\(lightweight\))19
b(threads.)-150 2301 y(Only)d(one)h(of)f(these)h(threads)g(can)f(e)o(x)
o(ecute)h(Hask)o(ell)g(code)g(at)f(an)o(y)h(one)f(time;)-150
2385 y(the)24 b(global)g(lock)g(that)f(ensures)h(this)f(is)h(referred)f
(to)h(as)f(\223the)h(Capability\224.)-150 2468 y(GHC')l(s)19
b(main)g(scheduler)i(loop)f(is)f(in)m(v)o(ok)o(ed)i(in)e(all)g
(threads;)h(all)f(b)o(ut)h(one)g(of)-150 2551 y(the)f(scheduler)h
(loops)g(are)e(w)o(aiting)i(for)e(the)h(Capability)g(at)g(an)o(y)g(one)
h(time.)-150 2717 y(Ha)o(ving)35 b(more)h(than)g(one)g(Capability)f(a)o
(v)n(ailable)g(w)o(ould)h(indicate)g(that)-150 2800 y(truly)d
(simultaneous)h(multithreaded)g(Hask)o(ell)g(e)o(x)o(ecution)g(is)f(a)o
(v)n(ailable;)-150 2883 y(our)19 b(current)g(implementation)h(does)g
(not)f(ho)n(we)n(v)o(er)h(support)f(this,)g(because)-150
2966 y(it)k(w)o(ould)h(require)f(synchronised)i(access)f(to)f(the)h
(heap)g(and)f(other)h(shared)-150 3049 y(state.)40 b(Whether)25
b(the)f(implementation)i(can)f(be)g(practically)g(e)o(xtended)h(in)-150
3132 y(this)19 b(direction)g(is)f(an)i(open)g(question.)-150
3314 y Fj(6.3.1)90 b(P)-7 b(assing)21 b(ar)l(ound)f(the)j(Capability)
-150 3481 y Fr(A)k(thread)i(will)d(relinquish)j(its)e(Capability)g
(\(i.e.)49 b(e)o(x)o(ecution)29 b(of)e(Hask)o(ell)-150
3564 y(code)i(will)f(continue)h(in)g(a)f(dif)n(ferent)h(OS)f(thread\))g
(under)i(the)e(follo)n(wing)-150 3647 y(conditions:)-82
3810 y(1.)42 b(A)19 b(safe)g(\(i.e.)j(non-blocking\))f(foreign)f(call)e
(is)h(made)g(\(FCALL1/2\).)16 3931 y(F)o(or)i(an)h(unsafe)h(call,)f(we)
g(just)f(hold)i(on)f(to)g(the)f(Capability)-5 b(,)23
b(thereby)16 4014 y(pre)n(v)o(enting)d(an)o(y)g(other)f(threads)g(from)
g(running.)-82 4134 y(2.)42 b(Another)29 b(OS)e(thread)i(is)f(w)o
(aiting)g(to)g(re)o(gain)h(the)f(Capability)g(after)16
4217 y(returning)20 b(from)f(a)f(foreign)i(call.)-82
4337 y(3.)42 b(Another)23 b(OS)e(thread)i(is)e(w)o(aiting)h(for)g(the)g
(Capability)h(because)g(that)16 4420 y(thread)c(is)g(handling)h(a)f
(foreign)g(call-in.)-82 4541 y(4.)42 b(The)19 b(scheduler)h(loop)g
(determines)f(that)g(the)g(ne)o(xt)g(Hask)o(ell)g(thread)h(to)16
4624 y(run)f(may)g(not)g(be)f(run)h(in)g(the)f(OS)g(thread)h(that)f
(holds)h(the)g(Capability)-5 b(.)16 4744 y(When)31 b(a)f(scheduler)h
(loop)g(encounters)h(a)e(Hask)o(ell)h(thread)g(that)f(is)16
4827 y(bound)c(to)f(a)f(dif)n(ferent)h(OS)f(thread,)i(it)e(has)h(to)g
(pass)g(the)g(Capability)16 4910 y(to)h(that)g(OS)g(thread.)45
b(When)27 b(a)f(scheduler)i(in)e(a)g(bound)i(OS)d(thread)16
4993 y(encounters)20 b(an)f(unbound)i(thread,)e(it)f(has)h(to)g(pass)g
(the)g(Capability)g(to)16 5076 y(a)g(w)o(ork)o(er)h(OS)e(thread.)-82
5197 y(5.)42 b(The)18 b(Hask)o(ell)h(thread)g(bound)h(to)e(the)h
(current)f(OS)g(thread)h(terminates)16 5280 y(\(HRET\).)16
5400 y(If)k(the)g(current)g(OS)f(thread)i(has)f(a)g(bound)i(Hask)o(ell)
e(thread)g(and)h(this)2215 83 y(Hask)o(ell)19 b(thread)h(terminates)f
(by)h(returning,)f(the)g(OS)f(thread)i(will)e(re-)2215
166 y(lease)e(the)h(Capability)f(and)h(the)f(scheduler)i(loop)f(will)e
(e)o(xit,)h(returning)2215 249 y(to)j(the)g(foreign)g(code)h(that)f
(called)g(it.)2049 424 y(Threads)j(that)g(are)g(just)f(returning)i
(from)f(a)f(foreign)i(call)e(and)i(threads)f(that)2049
507 y(are)g(handling)i(a)e(call)f(to)h(Hask)o(ell)h(from)f(foreign)h
(code)g(are)f(gi)n(v)o(en)h(priority)2049 590 y(o)o(v)o(er)c(other)h
(threads;)g(whene)n(v)o(er)g(it)e(enters)i(the)f(scheduler)m(,)h(the)f
(thread)h(that)2049 673 y(holds)g(the)g(capability)h(checks)f(whether)h
(it)e(should)i(yield)e(its)h(capability)g(to)2049 756
y(a)f(higher)o(-priority)g(thread)g(\(items)g(2)g(and)g(3)h(in)e(the)h
(abo)o(v)o(e)h(list\).)2049 922 y(After)g(yielding)h(the)g(capability)g
(and)g(after)g(passing)g(the)g(capability)g(to)g(an-)2049
1005 y(other)i(thread)g(\(item)g(4)g(in)g(the)f(list\),)h(the)g(thread)
g(will)f(immediately)h(try)g(to)2049 1088 y(reacquire)29
b(the)f(capability;)33 b(the)28 b(thread)g(will)f(be)i(block)o(ed)g
(until)f(another)2049 1171 y(thread)19 b(passes)g(a)g(capability)g(to)f
(it)g(again)h(\(via)f(item)g(4)h(abo)o(v)o(e\),)g(or)f(until)h(the)2049
1254 y(Capability)j(becomes)g(free)f(without)h(being)g(e)o(xplicitly)f
(passed)i(an)o(ywhere)2049 1337 y(\(item)18 b(5\).)2049
1571 y Fs(6.4)99 b(I/O)24 b(Multiplexing)2049 1738 y
Fr(T)m(raditional)32 b(\223multiple)o(xing\224)g(run)g(time)e(systems)i
(that)f(do)h(not)g(support)2049 1821 y(non-blocking)h(foreign)f(calls)f
(usually)g(still)f(pro)o(vide)i(support)g(for)f(non-)2049
1904 y(blocking)20 b(input)g(and)f(output.)2049 2070
y(The)f(ob)o(vious)h(w)o(ay)g(to)e(do)i(this)e(on)i(POSIX)d(systems)j
(is)e(to)h(use)g(the)g Fl(select)2049 2153 y Fr(or)h
Fl(poll)f Fr(system)h(calls)g(together)g(with)f(non-blocking)j(I/O.)c
(When)i(a)g Fl(read)2049 2236 y Fr(or)36 b Fl(write)h
Fr(request)g(f)o(ails)f(to)g(return)h(the)f(requested)h(amount)h(of)e
(data,)2049 2319 y(the)27 b(Hask)o(ell)h(thread)g(in)f(question)h(will)
f(be)g(suspended.)50 b(The)28 b(scheduler)2049 2402 y(loop)g(will)f
(periodically)h(use)g Fl(select)f Fr(or)h Fl(poll)g Fr(to)f(check)h
(whether)g(an)o(y)2049 2485 y(suspended)j(Hask)o(ell)f(threads)f(need)h
(to)f(be)g(w)o(ok)o(en)i(up;)j(if)29 b(there)g(are)g(no)2049
2568 y(runnable)c(Hask)o(ell)f(threads,)g(the)g(entire)g(run-time)f
(system)h(will)f(block)h(in)2049 2652 y(the)19 b Fl(select)g
Fr(or)g Fl(poll)g Fr(system)h(call.)2049 2818 y(The)27
b(Concurrent)i(FFI)d(mak)o(es)i(this)f(machinery)i(unnecessary;)k(a)27
b(\223safe\224)2049 2901 y(foreign)k(call)f(to)h Fl(read)f
Fr(or)h Fl(write)g Fr(will)e(ha)o(v)o(e)i(the)g(desired)g(ef)n(fect)f
(for)h(a)2049 2984 y(multi-threaded)16 b(Hask)o(ell)g(program.)23
b(Ho)n(we)n(v)o(er)m(,)17 b(using)f Fl(select)g Fr(or)g
Fl(poll)f Fr(it)2049 3067 y(is)k(possible)g(to)g(achie)n(v)o(e)h(much)g
(better)f(performance)h(than)g(using)f(safe)g(for)o(-)2049
3150 y(eign)k(calls,)g(because)h(it)e(does)h(not)g(require)g(an)g(e)o
(xtra)g(OS)e(thread)j(for)e(each)2049 3233 y(potentially-blocking)f
(I/O)d(operation.)2049 3399 y(At)i(\002rst,)h(we)g(tried)f(e)o
(xtending)j(GHC')l(s)d(e)o(xisting)h(\(single-OS-thread\))g(im-)2049
3482 y(plementation)e(of)e(I/O)g(multiple)o(xing)h(to)g(w)o(ork)g(with)
f(the)h(hybrid)g(threading)2049 3565 y(model)e(described)h(abo)o(v)o
(e.)23 b(In)16 b(this)f(scheme,)i(an)f(OS)f(thread)h(that)f(blocks)i
(in-)2049 3648 y(side)g Fl(select)h Fr(still)e(held)h(the)h(Capability)
f(to)g(pre)n(v)o(ent)h(multiple)f(OS)f(threads)2049 3731
y(from)26 b(using)h Fl(select)g Fr(simultaneously)-5
b(.)46 b(When)27 b(foreign)f(code)h(called)g(in)2049
3814 y(to)20 b(or)g(returned)g(to)g(Hask)o(ell)g(while)g(the)g(R)l(TS)e
(w)o(as)i(w)o(aiting)g(for)g(I/O,)e(it)i(w)o(as)2049
3897 y(necessary)h(to)e(interrupt)g(the)h Fl(select)f
Fr(by)h(sending)h(a)e(dummy)i(byte)e(across)2049 3980
y(a)e(pipe,)g(which)h(slo)n(wed)f(do)n(wn)h(foreign)g(calls)f(\(both)g
(incoming)h(and)g(outgo-)2049 4063 y(ing\))h(a)g(lot.)2049
4229 y(F)o(ortunately)-5 b(,)24 b(it)f(turned)h(out)g(that)f(a)g(more)h
(ef)n(\002cient)f(solution)h(can)g(be)f(im-)2049 4312
y(plemented)c(entirely)g(in)f(Hask)o(ell,)h(with)f(no)h(special)f
(support)i(from)e(the)g(run)2049 4395 y(time)h(system)g(be)o(yond)h
(the)f(e)o(xtensions)h(described)g(in)f(this)g(paper)l(.)2049
4561 y(The)j(Hask)o(ell)g(I/O)f(library)h(spa)o(wns)h(an)f(unbound)i
(Hask)o(ell)f(thread,)g(called)2049 4644 y(the)d(\223I/O)g(Service)g
(Thread\224,)h(which)f(uses)h(a)f(foreign)g(call)g(to)g
Fl(select)h Fr(or)f(a)2049 4727 y(similar)i(system)h(call)f(to)h(w)o
(atch)g(a)g(set)f(of)h(\002le)f(descriptors.)35 b(One)23
b(of)f(these)2049 4810 y(\002le)d(descriptors)g(is)g(the)h(read)f(end)h
(of)g(a)f(dedicated)h(\223w)o(ak)o(eup)h(pipe\224)f(which)2049
4893 y(will)c(be)h(used)h(to)e(notify)i(the)f(service)g(thread)g(when)h
(the)f(set)f(of)h(\002le)f(descrip-)2049 4976 y(tors)j(to)g(be)g(w)o
(atched)h(has)f(changed.)2049 5142 y(When)e(an)f(unbound)j(Hask)o(ell)d
(thread)h(needs)g(to)g(block)g(in)f(order)h(to)f(w)o(ait)g(for)2049
5225 y(some)j(I/O,)f(it)h(will)f(do)h(the)g(follo)n(wing:)2117
5400 y(1.)42 b(Store)22 b(the)h(\002le)e(descriptor)i(in)g(question)g
(in)f(a)h(global)g(mutable)g(v)n(ari-)1931 5649 y(8)p
eop
%%Page: 9 9
9 8 bop 16 83 a Fr(able)19 b(\(an)g Fl(MVar)p Fr(\).)-82
203 y(2.)42 b(W)-6 b(ak)o(e)25 b(up)g(the)g(service)g(thread)h(by)f
(writing)g(a)f(byte)i(to)e(the)h(w)o(ak)o(eup)16 286
y(pipe.)-82 407 y(3.)42 b(W)-6 b(ait)18 b(for)h(the)g(service)g(thread)
g(to)g(notify)g(us)h(via)f(an)g Fl(MVar)p Fr(.)-150 584
y(The)g(I/O)f(service)h(thread)h(will)e(repeatedly)i(do)f(the)g(follo)n
(wing:)-82 761 y(1.)42 b(Grab)21 b(the)g(set)f(of)h(\002le)f
(descriptors)h(to)g(be)g(w)o(atched)h(from)e(the)h(global)16
844 y(mutable)e(v)n(ariable.)-82 964 y(2.)42 b(Do)26
b(a)f(safe)h(foreign)g(call)f(to)g Fl(select)h Fr(or)g(a)f(similar)g
(system)h(call)f(in)16 1047 y(order)c(to)g(block)g(until)g(the)f
(status)h(of)g(one)g(of)g(the)g(\002le)e(descriptors)j(or)16
1130 y(of)d(the)g(w)o(ak)o(eup)i(pipe)e(changes.)-82
1251 y(3.)42 b(If)19 b(a)g(byte)h(has)g(arri)n(v)o(ed)f(on)h(the)f(w)o
(ak)o(eup)i(pipe,)f(read)g(it)e(from)h(there)h(in)16
1334 y(order)f(to)g(reset)g(the)g(pipe')l(s)g(state)g(to)g
(non-readable.)-82 1454 y(4.)42 b(Notify)15 b(all)g(Hask)o(ell)h
(threads)g(w)o(aiting)g(for)f(\002le)g(descriptors)h(that)g(ha)o(v)o(e)
16 1537 y(become)k(readable)g(or)f(writable)f(via)h(their)g
Fl(MVar)p Fr(s.)-82 1658 y(5.)42 b(Repeat.)-150 1835
y(When)22 b(a)f(bound)i(thread)f(needs)g(to)g(w)o(ait)f(for)g(a)h
(\002le)e(descriptor)i(to)g(become)-150 1918 y(readable,)e(it)f(should)
i(just)e(safe-call)h Fl(select)g Fr(for)f(that)h(\002le)f(descriptor)m
(,)h(be-)-150 2001 y(cause)e(that)e(will)g(be)i(more)f(ef)n(\002cient)g
(than)g(w)o(aking)h(the)f(I/O)f(service)i(thread.)-150
2167 y(This)24 b(scheme)i(manages)g(to)f(k)o(eep)h(the)f(number)h(of)f
(separate)g(OS)f(threads)-150 2250 y(used)c(when)g Fq(n)g
Fr(unbound)i(threads)e(are)f(doing)h(I/O)f(at)g(the)h(same)g(time)f(do)
n(wn)-150 2333 y(to)e(just)g(tw)o(o)h(as)f(opposed)i(to)e
Fq(n)h Fr(when)g(safe)f(foreign)h(calls)f(are)g(used.)23
b(GHC')l(s)-150 2416 y(pre)n(vious)f(scheme)g(\(released)g(in)f(GHC)f
(6.2\))h(needed)i(just)d(one)i(OS)e(thread)-150 2499
y(in)f(the)g(same)g(situation,)f(b)o(ut)h(at)g(the)f(cost)h(of)g(one)h
(call)e(to)h(select)g(e)n(v)o(ery)g(time)-150 2582 y(through)e(the)f
(scheduler)h(loop,)g(a)f Fl(write\(\))g Fr(to)g(a)g(pipe)g(for)g(e)n(v)
o(ery)h(\(safe\))e(for)o(-)-150 2665 y(eign)k(call,)f(and)i(a)e(lot)g
(of)h(additional)h(comple)o(xity)f(in)g(the)f(run)h(time)g(system.)-150
2831 y(The)29 b(ne)n(w)g(scheme)g(requires)h(no)f(help)g(from)g(the)f
(run)i(time)e(system,)j(re-)-150 2914 y(mo)o(v)o(es)22
b(the)f(periodic)h(call)f(to)g Fl(select)g Fr(and)h(supports)g(more)g
(ef)n(\002cient)e(for)o(-)-150 2997 y(eign)g(calls,)g(at)g(the)g(cost)g
(of)g(some)h(inter)o(-OS-thread)e(messaging)i(for)f(e)n(v)o(ery)-150
3080 y(read)k(or)g(write)f(that)g(actually)h(needs)h(to)f(block.)38
b(According)25 b(to)f(our)g(mea-)-150 3163 y(surements,)19
b(this)g(o)o(v)o(erhead)h(can)g(be)f(ne)o(glected.)-150
3329 y(Note)27 b(also)g(that)f(this)h(scheme)g(is)f(not)h(tied)g(to)g
(GHC')l(s)f(hybrid)h(threading)-150 3412 y(model;)19
b(While)e(there)i(w)o(ould)g(be)f(no)h(performance)h(gain)e(for)g(a)g
(one-to-one)-150 3495 y(implementation,)31 b(it)c(also)i(mak)o(es)g
(sense)f(to)g(use)h(this)f(I/O)f(multiple)o(xing)-150
3578 y(scheme)18 b(on)f(top)g(of)g(the)g(all-in-one-OS-thread)g
(implementation)h(outlined)-150 3661 y(in)h(Section)g(6.2.)-150
3905 y Fs(7)99 b(Related)26 b(W)-7 b(ork)-150 4072 y
Fr(W)h(e)24 b(belie)n(v)o(e)i(there)f(is)f(nothing)i(in)f(the)g
(literature)f(that)h(bears)g(directly)g(on)-150 4155
y(the)i(particular)g(issues)g(addressed)h(in)e(this)h(paper)l(.)47
b(Ho)n(we)n(v)o(er)m(,)29 b(there)e(is)f(a)-150 4238
y(great)21 b(deal)f(of)h(folklore)f(and)h(e)o(xisting)g(practice)g(in)f
(the)g(form)h(of)f(language)-150 4321 y(implementations,)g(which)f(we)g
(re)n(vie)n(w)g(here.)-150 4487 y(T)-6 b(o)26 b(summarise)h(the)f
(related)h(w)o(ork:)38 b(there)27 b(is)f(a)g(general)h(trend)g(amongst)
-150 4570 y(languages)40 b(with)f(concurrenc)o(y)h(support)g(to)f(mo)o
(v)o(e)g(from)g(lightweight)-150 4653 y(threads)26 b(to)g(OS)f(threads)
h(in)f(one-to-one)j(mapping)e(with)g(the)f(language')l(s)-150
4736 y(o)n(wn)i(threads.)47 b(The)27 b(most)f(commonly)i(quoted)g
(reasons)g(for)e(the)h(switch)-150 4819 y(are)i(for)g(accessing)i
(foreign)f(library)f(functions)h(that)f(might)h(block,)i(and)-150
4902 y(scaling)19 b(to)g(SMP)f(machines.)-150 5068 y(In)27
b(relation)f(to)h(this)f(paper)m(,)j(all)d(of)h(these)g(languages)h
(could)f(support)h(the)-150 5151 y(bound/unbound)f(thread)d(concept,)h
(which)e(w)o(ould)h(then)g(gi)n(v)o(e)g(the)f(imple-)-150
5234 y(mentation)j(freedom)h(to)e(use)h(cheaper)h(lightweight)f
(threads)g(for)g(the)f(un-)-150 5317 y(bound)19 b(threads.)k(T)-6
b(o)18 b(our)g(kno)n(wledge,)h(there)e(are)h(no)g(other)g(languages)h
(that)-150 5400 y(actually)g(do)h(support)f(this)g(idea.)2049
83 y Fs(7.1)99 b(J)o(a)n(v)o(a)2049 250 y Fr(Ja)o(v)n(a[2)q(])15
b(be)o(gan)h(with)f(a)h(lightweight)g(threading)g(implementation,)h
(with)e(all)2049 333 y(Ja)o(v)n(a)20 b(threads)h(managed)h(by)e(a)g
(single)h(OS)e(thread)i(\(Ja)o(v)n(a)f(calls)g(this)g(\223green)2049
416 y(threads\224\).)25 b(Later)19 b(implementations)h(of)f(Ja)o(v)n(a)
h(mo)o(v)o(ed)g(to)f(a)h(nati)n(v)o(e)f(thread-)2049
499 y(ing)g(model,)g(where)g(each)g(Ja)o(v)n(a)g(thread)g(is)g(mapped)h
(to)e(its)g(o)n(wn)i(OS)e(thread.)2049 582 y(The)h(reasons)h(for)e(the)
h(switch)g(seem)g(to)g(be)g(primarily)2136 776 y Fp(\017)42
b Fr(Non-scalability)19 b(of)g(green)h(threads)f(to)g(SMP)f(machines)
2136 897 y Fp(\017)42 b Fr(Inability)36 b(to)f(call)h(functions)g(in)g
(e)o(xternal)g(libraries)f(which)h(may)2215 980 y(block,)19
b(without)g(blocking)i(the)e(entire)f(system)2049 1174
y(And)g(perhaps)h(the)e(moti)n(v)n(ation)i(w)o(as)e(partly)h(due)g(to)g
(the)f(JNI,)g(which)h(w)o(orks)2049 1257 y(smoothly)i(because)g(nati)n
(v)o(e)f(threads)h(are)f(one-to-one)h(with)f(Ja)o(v)n(a)g(threads.)2049
1423 y(In)24 b(contrast)h(to)f(Ja)o(v)n(a,)i(scaling)f(to)f(SMP)g
(machines)h(is)f(not)h(a)f(goal)h(for)f(us.)2049 1506
y(There)g(is)g(no)h(ef)n(\002cient)f(SMP-capable)h(Concurrent)h(Hask)o
(ell)e(implemen-)2049 1589 y(tation,)18 b(because)h(doing)h(so)e(is)g
(still)f(an)h(open)h(research)g(question;)g(the)g(main)2049
1672 y(sticking)k(point)h(is)f(ho)n(w)g(to)g(synchronise)i(access)f(to)
f(the)g(main)g(shared)h(re-)2049 1755 y(source)g(\(the)e(heap\))i
(without)f(killing)g(performance)h(of)f(the)g(system.)35
b(Fur)o(-)2049 1838 y(thermore,)27 b(scaling)f(to)g(multiprocessors)g
(can)h(often)e(be)h(achie)n(v)o(ed)h(in)f(the)2049 1921
y(same)20 b(w)o(ays)f(as)h(scaling)f(to)h(a)f(cluster)m(,)g(by)h(using)
g(multiple)f(processes)h(with)2049 2004 y(e)o(xplicit)f(communication.)
2049 2317 y Fs(7.2)99 b(O'Caml)2049 2483 y Fr(O'Caml[4])19
b(supports)g(a)g(choice)h(between)g(user)o(-le)n(v)o(el)e(and)i(nati)n
(v)o(e)f(threads)2049 2566 y(for)34 b(its)g(bytecode)h(interpreter)m(,)
j(b)o(ut)c(compiled)h(code)g(must)f(use)g(nati)n(v)o(e)2049
2649 y(threads.)56 b(An)29 b(O'Caml)g(programmer)i(using)f(nati)n(v)o
(e)g(threads)g(may)g(cur)o(-)2049 2732 y(rently)c(assume)g(that)f(each)
i(O'Caml)e(thread)h(is)f(mapped)i(to)e(a)h(single)g(OS)2049
2815 y(thread)19 b(for)g(the)g(purposes)h(of)f(calling)g(e)o(xternal)h
(libraries.)2049 2982 y(Nati)n(v)o(e)30 b(threads)g(were)f(chosen)i(o)o
(v)o(er)f(user)o(-le)n(v)o(el)f(threads)h(for)g(compiled)2049
3065 y(code)20 b(for)f(the)g(follo)n(wing)g(reasons:)2136
3259 y Fp(\017)42 b Fr(The)27 b(dif)n(\002culty)g(of)g(implementing)h
(multithreaded)g(I/O)f(in)g(a)g(user)o(-)2215 3342 y(le)n(v)o(el)15
b(scheduler)h(across)f(multiple)g(platforms)g(is)g(high.)22
b(Using)15 b(nati)n(v)o(e)2215 3425 y(threads)j(allo)n(ws)f(this)g
(issue)g(to)h(be)f(handed)i(of)n(f)e(to)g(the)g(operating)i(sys-)2215
3508 y(tem,)25 b(which)f(signi\002cantly)g(reduces)h(implementation)g
(comple)o(xity)2215 3591 y(and)20 b(impro)o(v)o(es)f(portability)-5
b(.)2136 3711 y Fp(\017)42 b Fr(Compiled)e(O'Caml)f(threads)h(use)g
(the)g(machine)g(stack.)86 b(W)m(ith)2215 3794 y(user)o(-le)n(v)o(el)33
b(threads,)j(the)d(scheduler)h(must)f(therefore)h(be)f(able)g(to)2215
3877 y(manage)25 b(multiple)f(machine)g(stacks,)h(which)f(is)g(hea)o
(vily)g(platform-)2215 3960 y(dependent.)2049 4155 y(In)k(O'Caml,)i(a)e
(non-blocking)i(foreign)f(call)f(is)g(made)h(by)f(de\002ning)h(a)f(C)
2049 4238 y(function)33 b(which)g(wraps)g(the)g(foreign)g(call)f
(between)i(the)e(special)h(calls)2049 4321 y Fl
(enter_blocking_section\(\))24 b Fr(and)f Fl
(leave_blocking_section\(\))p Fr(;)2049 4404 y(this)49
b(may)h(only)g(be)g(done)h(when)f(using)g(the)f(nati)n(v)o(e)h
(implementa-)2049 4487 y(tion)d(of)f(threads.)107 b(Similarly)-5
b(,)52 b(calls)46 b(to)g(O'Caml)g(functions)i(from)2049
4570 y(C)34 b(must)h(be)g(wrapped)h(between)f Fl
(leave_blocking_section\(\))i Fr(and)2049 4653 y Fl
(enter_blocking_section\(\))p Fr(.)25 b(This)15 b(is)h(equi)n(v)n
(alent)i(to,)e(if)g(slightly)g(less)2049 4736 y(con)m(v)o(enient)k
(than,)f(Hask)o(ell')l(s)h Fl(safe)f Fr(foreign)g(calls)g(and)g
(callbacks.)2049 4902 y(O'Caml)27 b(could)h(straightforw)o(ardly)h(be)e
(e)o(xtended)i(with)f(the)f(concept)i(of)2049 4985 y(bound)d(threads,)h
(which)e(w)o(ould)g(lea)o(v)o(e)g(the)g(implementation)g(free)g(to)f
(use)2049 5068 y(user)o(-le)n(v)o(el)e(threads)h(with)e(a)h(pool)h(of)f
(nati)n(v)o(e)h(threads)f(for)g(foreign)h(calls)f(in)2049
5151 y(the)16 b(same)h(w)o(ay)f(as)g(GHC.)f(This)h(w)o(ould)h(of)f
(course)h(entail)f(more)g(implemen-)2049 5234 y(tation)g(comple)o(xity)
-5 b(,)18 b(which)e(may)h(be)f(w)o(orse)h(than)f(for)h(GHC)e(due)i(to)f
(the)g(use)2049 5317 y(of)k(the)g(machine)h(stack)f(by)h(O'Caml)e(nati)
n(v)o(e)i(code)g(as)f(noted)g(abo)o(v)o(e)h(\(GHC)2049
5400 y(uses)e(separate)h(thread)f(stacks)g(managed)i(by)e(the)g
(runtime\).)1931 5649 y(9)p eop
%%Page: 10 10
10 9 bop -150 83 a Fs(7.3)99 b(C)p Fa(])25 b Fs(and)g(.NET)-150
250 y Fr(The)40 b(.NET)f(Common)i(Language)g(Runtime)f(\(CLR\))f(uses)h
(a)g(one-to-)-150 333 y(one)28 b(mapping)h(between)f(CLR)f(threads)h
(and)g(nati)n(v)o(e)g(W)m(indo)n(ws)g(threads.)-150 416
y(Hence,)19 b(threads)h(in)e(C)p Fh(])h Fr(are)g(f)o(airly)g(hea)o
(vyweight.)-150 582 y(T)-6 b(o)51 b(mitigate)f(this,)58
b(the)51 b(.NET)e(base)j(class)f(libraries)f(include)i(the)-150
665 y Fl(ThreadPool)29 b Fr(class,)g(which)f(manages)h(a)f(pool)g(of)g
(w)o(ork)o(er)h(threads)f(and)-150 748 y(a)22 b(queue)h(of)f(tasks)g
(to)g(be)h(performed,)g(including)g(asynchronous)i(I/O)c(and)-150
831 y(timers.)38 b(The)24 b Fl(ThreadPool)g Fr(class)g(multiple)o(x)o
(es)h(the)f(w)o(aiting)g(operations)-150 914 y(onto)17
b(a)e(single)h(thread,)h(which)f(signi\002cantly)h(reduces)f(the)g
(cost)g(of)g(a)g(block-)-150 997 y(ing)32 b(operation)h(compared)g
(with)e(using)i(a)e(ne)n(w)i(thread.)62 b(Computation)-150
1080 y(tasks)27 b(can)h(also)g(be)f(submitted)h(to)f(the)h
Fl(ThreadPool)p Fr(,)h(and)f(will)f(be)g(per)o(-)-150
1163 y(formed)33 b(whene)n(v)o(er)g(there)f(is)g(a)f(free)h(thread)h
(in)f(the)g(pool.)63 b(Therefore,)-150 1246 y Fl(ThreadPool)p
Fr(s)31 b(achie)n(v)o(e)g(cheaper)g(concurrenc)o(y)h(by)f(a)o(v)o
(oiding)f(repeated)-150 1329 y(thread)24 b(creation/deletion,)h(at)e
(the)g(e)o(xpense)i(of)f(possibly)g(ha)o(ving)g(to)f(w)o(ait)-150
1412 y(for)c(a)g(computation)h(to)f(be)g(performed)h(if)e(the)h(thread)
h(pool)f(is)g(empty)-5 b(.)-150 1578 y(When)26 b(used)g(for)g(multiple)
g(I/O)f(requests,)j(the)e Fl(ThreadPool)g Fr(concept)h(is)-150
1661 y(basically)e(equi)n(v)n(alent)h(to)f(the)g(I/O)f(multiple)o(xing)
h(scheme)h(used)g(in)e(GHC)-150 1744 y(\(Section)c(6.4\).)25
b(The)20 b(main)g(dif)n(ference)h(is)e(that)h(GHC')l(s)f(scheme)h(is)g
(hidden)-150 1827 y(from)25 b(the)g(programmer)m(,)j(who)d
(automatically)h(gets)f(the)g(bene\002t)h(of)f(opti-)-150
1910 y(mised)f(multiple)o(xing)h(for)e(all)h(I/O)f(operations)i(pro)o
(vided)g(the)f(underlying)-150 1993 y(implementation)c(supports)g(it.)
-150 2244 y Fs(7.4)99 b(User)l(-le)o(v)o(el)25 b(vs.)30
b(k)o(er)o(nel)c(thr)n(eads)-150 2411 y Fr(Why)f(should)i(we)f(care)f
(about)i(lightweight)f(threads?)44 b(Man)o(y)27 b(other)f(lan-)-150
2494 y(guages)20 b(ha)o(v)o(e)e(ditched)h(the)g(concept)g(in)g(f)o(a)o
(v)o(our)f(of)g(a)h(one-to-one)g(mapping)-150 2577 y(between)h(the)f
(language')l(s)h(o)n(wn)f(threads)h(and)f(nati)n(v)o(e)h(OS)e(threads.)
-150 2743 y(The)25 b(reason)g(is)g(that)g(lightweight)g(Hask)o(ell)g
(threads)g(can)g(still)f(be)h(signi\002-)-150 2826 y(cantly)c(cheaper)g
(than)f(using)h(OS)f(threads.)27 b(F)o(or)20 b(e)o(xample,)h(the)f(f)o
(astest)g(im-)-150 2909 y(plementation)c(of)g(nati)n(v)o(e)g(threads)g
(on)f(Linux,)h(the)g(Nati)n(v)o(e)f(POSIX)f(Threads)-150
2992 y(Library[6])23 b(claims)g(20)p Fq(\265)p Fr(sec)i(per)e(thread)h
(creation/e)o(xit,)g(whereas)f(GHC')l(s)-150 3075 y(implementation)16
b(of)f(Concurrent)h(Hask)o(ell)f(can)h(achie)n(v)o(e)g(an)f(order)g(of)
g(mag-)-150 3158 y(nitude)26 b(impro)o(v)o(ement)h(o)o(v)o(er)f(this:)
36 b(the)26 b Fl(conc004)g Fr(test)g(from)f(GHC')l(s)g(test)-150
3241 y(suite)f(performed)h(10)424 3214 y Fc(6)482 3241
y Fr(thread)g(creation/e)o(xit)f(operations)h(in)f(1.3sec)h(on)g(a)-150
3324 y(1Gz)c(PIII,)f(gi)n(ving)i(a)f(thread)h(creation/e)o(xit)f(time)g
(of)g(1.3)p Fq(\265)p Fr(sec.)30 b(The)21 b(NPTL)-150
3407 y(paper)c(doesn')o(t)f(gi)n(v)o(e)g(details)g(on)h(what)e(hardw)o
(are)i(w)o(as)g(used)f(for)g(their)g(mea-)-150 3490 y(surements,)25
b(b)o(ut)d(a)h(1GHz)h(PIII)e(w)o(ould)h(seem)h(to)f(be)g(a)g
(reasonable)h(guess,)-150 3574 y(being)c(a)f(midrange)g(system)h(at)e
(the)h(date)g(of)g(that)g(publication.)-150 3740 y(Nati)n(v)o(e)e
(threads)h(on)f(other)h(OSs)e(are)h(e)n(v)o(en)h(more)g(e)o(xpensi)n(v)
o(e;)g(W)m(indo)n(ws)g(for)-150 3823 y(e)o(xample)i(has)f(notoriously)h
(e)o(xpensi)n(v)o(e)g(operating)g(system)g(threads.)-150
3989 y(These)36 b(implementations)h(of)f(OS)g(threads)g(are)g(mapping)i
(OS)d(threads)-150 4072 y(onto)24 b Fq(k)o(ernel)h(thr)m(eads)p
Fr(,)g(and)g(the)e(k)o(ernel)i(is)e(managing)i(the)f(scheduling)h(of)
-150 4155 y(threads.)31 b(This)20 b(is)h(the)h(reason)g(for)f(much)h
(of)f(the)g(o)o(v)o(erhead:)29 b(man)o(y)22 b(thread)-150
4238 y(operations)e(require)f(a)g(trip)g(into)g(the)f(k)o(ernel.)-150
4404 y(So)j(can)g(OS)f(threads)i(be)f(implemented)h(in)f(user)g(space?)
30 b(Certainly;)22 b(there)-150 4487 y(are)d(man)o(y)h(implementations)
h(of)e(purely)h(user)o(-space)g(threading)g(libraries,)-150
4570 y(and)f(these)g(are)g(indeed)h(often)f(f)o(aster)f(than)h(k)o
(ernel)h(threads.)j(One)c(problem,)-150 4653 y(ho)n(we)n(v)o(er)m(,)25
b(is)e(that)g(this)g(doesn')o(t)g(let)g(the)g(multithreaded)h
(application)g(tak)o(e)-150 4736 y(adv)n(antage)c(of)f(a)g
(multiprocessor;)g(for)g(that)f(you)i(need)f(at)f(least)h(one)g(k)o
(ernel)-150 4819 y(thread)24 b(for)f(each)i(processor)m(,)g(so)f(to)f
(this)h(end)g(hybrid)g(models)g(ha)o(v)o(e)g(been)-150
4902 y(de)n(v)o(eloped[8)r(,)17 b(3])f(which)i(use)f(a)g(mixture)g
(between)g(user)o(-space)h(and)f(k)o(ernel)-150 4985
y(threads)f(\(sometimes)g(called)g(an)h Fq(M)g Fr(:)c
Fq(N)20 b Fr(threading)d(model,)f(indicating)h(that)-150
5068 y Fq(M)22 b Fr(OS)c(threads)i(are)e(mapped)j(to)e
Fq(N)k Fr(k)o(ernel)c(threads\).)-150 5234 y(It)30 b(remains)h(to)f(be)
h(seen)g(whether)g(an)g(implementation)h(of)e(OS)g(threads)-150
5317 y(can)e(approach)g(the)g(performance)g(of)f(lightweight)g
(Concurrent)h(Hask)o(ell)-150 5400 y(threads.)k(If)21
b(that)g(were)h(to)f(happen,)j(then)e(there)g(w)o(ould)g(be)g(no)g
(reason)h(not)2049 83 y(to)17 b(use)g(a)f(one-to-one)i(implementation)g
(for)f(Concurrent)g(Hask)o(ell,)g(and)h(the)2049 166
y(bound/unbound)30 b(concept)d(w)o(ould)g(be)f(redundant.)46
b(Ho)n(we)n(v)o(er)m(,)28 b(there)e(are)2049 249 y(reasons)19
b(to)f(belie)n(v)o(e)g(that)g(this)g(is)f(unlik)o(ely)i(to)f(happen,)h
(at)f(least)g(in)f(the)h(near)2049 332 y(future:)2136
509 y Fp(\017)42 b Fr(The)19 b(Nati)n(v)o(e)h(POSIX)d(Threads)j
(Library[6)q(])e(is)h(1:1,)h(and)g(claims)f(bet-)2215
592 y(ter)31 b(performance)h(than)g(a)f(competing)h(N:M)f
(implementation[3)q(].)2215 675 y(The)f(impro)o(v)o(ement)g(is)f(lar)o
(gely)h(attrib)o(uted)f(to)h(the)f(comple)o(xity)i(of)2215
758 y(implementing)20 b(the)f(N:M)g(scheme.)2136 878
y Fp(\017)42 b Fr(Each)25 b(OS)f(threads)h(by)g(de\002nition)g(needs)h
(its)e(o)n(wn)h(machine)h(stack.)2215 961 y(Machine)f(stacks)f(are)g
(immo)o(v)n(able,)i(so)e(must)g(be)g(allocated)h(a)f(\002x)o(ed)2215
1044 y(portion)g(of)g(the)f(address)i(space)f(with)f(enough)i(room)f
(for)g(the)f(stack)2215 1127 y(to)j(gro)n(w)-5 b(.)45
b(Since)25 b(the)i(library)e(doesn')o(t)i(kno)n(w)g(ahead)g(of)f(time)f
(ho)n(w)2215 1210 y(much)i(stack)g(space)g(a)f(thread)h(will)e(need,)k
(it)d(must)g(guess,)j(and)e(in-)2215 1293 y(e)n(vitably)18
b(this)g(will)e(end)j(up)f(w)o(asting)g(a)g(lot)f(of)h(address)g
(space,)g(which)2215 1376 y(on)j(a)f(32-bit)h(machine)g(is)f(a)g
(scarce)h(resource.)28 b(In)21 b(contrast,)f(Hask)o(ell)2215
1459 y(threads)f(ha)o(v)o(e)g(stacks)f(that)h(are)f(fully)g(garbage)i
(collectable,)e(and)h(can)2215 1542 y(be)g(mo)o(v)o(ed)h(and)g(gro)n
(wn)f(at)g(will.)2049 1719 y(Anderson)e(et.)k(al.[5])16
b(proposed)h(a)e(w)o(ay)h(to)g(ef)n(fecti)n(v)o(ely)g(combine)g(the)g
(bene-)2049 1802 y(\002ts)h(of)h(user)o(-le)n(v)o(el)g(threads)h(and)g
(k)o(ernel)g(threads)f(by)h(ha)o(ving)g(e)o(xplicit)e(com-)2049
1885 y(munication)23 b(between)g(the)g(k)o(ernel)g(scheduler)g(and)g
(the)f(user)o(-le)n(v)o(el)g(thread)2049 1968 y(scheduler)l(.)53
b(A)28 b(deri)n(v)n(ati)n(v)o(e)i(of)e(this)h(scheme)g(is)f(currently)i
(being)f(imple-)2049 2051 y(mented)h(in)g(the)g(FreeBSD)e(operating)j
(system;)k(no)c(performance)g(mea-)2049 2134 y(surements)20
b(were)f(a)o(v)n(ailable)g(at)f(the)h(time)g(of)g(writing.)2049
2376 y Fs(8)99 b(Conclusion)2049 2543 y Fr(W)-6 b(e)20
b(ha)o(v)o(e)g(designed)h(a)g(simple)f(e)o(xtension)h(to)f(the)g(Hask)o
(ell)g(F)o(oreign)h(Func-)2049 2626 y(tion)i(Interf)o(ace,)h(for)f
(specifying)h(precisely)f(the)g(interaction)g(between)h(the)2049
2709 y(FFI)18 b(and)h(Concurrent)h(Hask)o(ell.)j(It)c(allo)n(ws)g(for)f
(the)h(follo)n(wing)h(features:)2136 2885 y Fp(\017)42
b Fr(Non-blocking)21 b(foreign)e(calls)2136 3006 y Fp(\017)42
b Fr(Callbacks)19 b(and)h(Call-ins)e(from)h(multithreaded)h
(applications)2136 3126 y Fp(\017)42 b Fr(Interacting)27
b(with)f(multithreaded)i(foreign)f(libraries,)h(and)f(foreign)2215
3209 y(libraries)19 b(that)f(mak)o(e)i(use)f(of)g(thread-local)h(state)
2049 3386 y(Furthermore,)d(the)g(e)o(xtensions)h(require)g(no)f(ne)n(w)
h(syntax,)f(and)h(ha)o(v)o(e)f(a)g(sim-)2049 3469 y(ple)22
b(operational)g(semantics.)33 b(A)21 b(fe)n(w)h(simple)f(library)h
(functions)h(are)f(pro-)2049 3552 y(vided)e(for)f(the)f(programmer)j
(to)d(w)o(ork)i(with)e(the)h(e)o(xtensions.)2049 3718
y(Moreo)o(v)o(er)m(,)32 b(we)d(ha)o(v)o(e)g(done)h(this)f(without)g
(requiring)g(an)o(y)g(fundamental)2049 3801 y(restructuring)e(of)f(e)o
(xisting)g(Hask)o(ell)g(implementations:)39 b(there)26
b(is)g(no)g(re-)2049 3884 y(quirement)h(that)f(the)h(Hask)o(ell)g
(runtime)f(be)h(multithreaded,)i(or)d(that)g(par)o(-)2049
3967 y(ticular)c(OS)f(threads)h(are)g(used)h(to)e(e)o(x)o(ecute)i(Hask)
o(ell)f(code.)33 b(Ho)n(we)n(v)o(er)m(,)23 b(we)2049
4050 y(do)e(accommodate)i(an)e(ef)n(\002cient)f(implementation)i(based)
f(on)h(lightweight)2049 4133 y(Hask)o(ell)d(threads)h(and)f(a)g(pool)h
(of)f(OS)f(w)o(ork)o(er)i(threads)f(for)g(e)o(x)o(ecution.)2049
4299 y(There)h(is)g(an)h(implementation)g(of)g(the)f(ef)n(\002cient)g
(scheme)i(in)e(a)g(production)2049 4382 y(Hask)o(ell)28
b(Compiler)f(\(GHC\),)f(and)i(we)f(are)h(currently)g(gathering)g(e)o
(xperi-)2049 4465 y(ence)20 b(in)e(using)i(it.)2049 4707
y Fs(9)99 b(Refer)n(ences)2086 4873 y Fr([1])42 b(The)d(Glasgo)n(w)g
(Hask)o(ell)g(Compiler)l(.)91 b Fl(http://www.haskell.)2215
4956 y(org/ghc)p Fr(.)2086 5076 y([2])42 b(The)19 b(Ja)o(v)n(a)g
(language.)28 b Fl(http://java.sun.com/)p Fr(.)2086 5197
y([3])42 b(Ne)o(xt)20 b(Generation)g(POSIX)f(Threading.)31
b Fl(http://www-)t(124.ibm.)2215 5280 y(com/pthreads/)p
Fr(.)2086 5400 y([4])42 b(The)19 b(O'Caml)f(language.)29
b Fl(http://www.ocaml.org/)p Fr(.)1913 5649 y(10)p eop
%%Page: 11 11
11 10 bop -113 83 a Fr([5])42 b(T)-6 b(.)24 b(E.)g(Anderson,)k(B.)c(N.)
g(Bershad,)j(E.)d(D.)g(Lazo)n(wska,)j(and)f(H.)e(M.)16
166 y(Le)n(vy)-5 b(.)36 b(Scheduler)23 b(acti)n(v)n(ations:)29
b(Ef)n(fecti)n(v)o(e)22 b(k)o(ernel)g(support)h(for)f(the)16
249 y(user)o(-le)n(v)o(el)f(management)h(of)f(parallelism.)32
b Fq(A)n(CM)20 b(T)l(r)o(ansactions)h(on)16 332 y(Computer)f(Systems)p
Fr(,)e(10\(1\):53\22679,)j(February)f(1992.)-113 452
y([6])42 b(Ulrich)k(Drepper)h(and)g(Ingo)g(Molnar)l(.)115
b(The)47 b(Nati)n(v)o(e)f(POSIX)16 535 y(Thread)55 b(Library)g(for)f
(linux.)142 b(T)-5 b(echnical)55 b(report,)64 b(Redhat,)16
619 y(February)33 b(2003.)70 b Fl(http://www.redhat.com/whitepapers/)16
702 y(developer/POSIX_Linux_Threading.pdf)p Fr(.)-113
822 y([7])42 b(Manuel)27 b(Chakra)o(v)n(arty)f(\(ed.\).)48
b(The)25 b(Hask)o(ell)h(98)g(foreign)g(function)16 905
y(interf)o(ace)c(1.0:)30 b(An)22 b(addendum)i(to)e(the)g(Hask)o(ell)g
(98)h(report.)36 b Fl(http:)16 988 y
(//www.cse.unsw.edu.au/\230chak/haskell/ffi/)p Fr(.)-113
1108 y([8])42 b(Richard)21 b(McDougall)g(and)g(Jim)f(Mauro.)32
b Fq(Solaris)20 b(Internals)p Fr(.)32 b(Pren-)16 1191
y(tice)19 b(Hall,)f(2000.)-113 1312 y([9])42 b(Simon)22
b(Pe)o(yton)g(Jones.)37 b(T)-6 b(ackling)22 b(the)g(a)o(wkw)o(ard)h
(squad:)30 b(monadic)16 1395 y(input/output,)g(concurrenc)o(y)-5
b(,)31 b(e)o(xceptions,)f(and)e(foreign-language)16 1478
y(calls)36 b(in)g(Hask)o(ell.)81 b(In)36 b(CAR)f(Hoare,)41
b(M)36 b(Bro)o(y)-5 b(,)40 b(and)d(R)e(Stein-)16 1561
y(brue)o(ggen,)20 b(editors,)f Fq(Engineering)h(theories)g(of)e
(softwar)m(e)i(construc-)16 1644 y(tion,)e(Marktober)m(dorf)j(Summer)d
(Sc)o(hool)i(2000)p Fr(,)f(N)m(A)-8 b(T)o(O)17 b(ASI)h(Series,)16
1727 y(pages)i(47\22696.)g(IOS)e(Press,)g(2001.)-150
1847 y([10])42 b(Simon)29 b(Pe)o(yton)h(Jones,)i(Andre)n(w)e(Gordon,)j
(and)d(Sigbjorn)f(Finne.)16 1930 y(Concurrent)17 b(Hask)o(ell.)k(In)16
b Fq(Confer)m(ence)i(Recor)m(d)f(of)f(the)g(23r)m(d)h(Annual)16
2013 y(A)n(CM)23 b(Symposium)h(on)h(Principles)e(of)h(Pr)m(o)o(gr)o
(amming)g(Langua)o(g)o(es)p Fr(,)16 2096 y(pages)g(295\226308,)j(St)22
b(Petersb)o(ur)o(g)h(Beach,)i(Florida,)e(January)i(1996.)16
2179 y(A)m(CM.)1913 5649 y(11)p eop
%%Trailer
end
userdict /end-hook known{end-hook}if
%%EOF
